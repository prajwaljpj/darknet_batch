[00;35m#include[m [00;31m"yolo_batch.hpp"[m[00;35m[m
[00;35m#include[m [00;31m"network.h"[m[00;35m [m

[00;32mextern[m [00;31m"C"[m [00;00m{[m
[00;35m#include[m [00;31m"detection_layer.h"[m[00;35m [m
[00;35m#include[m [00;31m"region_layer.h"[m[00;35m [m
[00;35m#include[m [00;31m"cost_layer.h"[m[00;35m [m
[00;35m#include[m [00;31m"utils.h"[m[00;35m [m
[00;35m#include[m [00;31m"parser.h"[m[00;35m [m
[00;35m#include[m [00;31m"box.h"[m[00;35m [m
[00;35m#include[m [00;31m"image.h"[m[00;35m [m
[00;35m#include[m [00;31m"demo.h"[m[00;35m [m
[00;35m#include[m [00;31m"option_list.h"[m[00;35m [m
[00;35m#include[m [00;31m"stb_image.h"[m[00;35m [m
[00;00m}[m
[00;35m#include <sys/time.h> [m
[00;35m#include <vector> [m
[00;35m#include <iostream> [m
[00;35m#include <algorithm> [m
[00;35m#include <iomanip> [m

[00;35m#define BATCH 3[m

[00;34m/*************************YOLO Batch***************************/[m
[00;32mYOLO_Batch[m[00;00m::[m[00;32mYOLO_Batch[m[00;00m()[m
[00;00m{[m
    [00;34m// [m
[00;00m}[m

[00;32mYOLO_Batch[m[00;00m::[m[00;32mYOLO_Batch[m[00;00m([m[00;32mstd[m[00;00m::[mstring cfgfile[00;00m,[m [00;32mstd[m[00;00m::[mstring weightfile[00;00m,[m [00;32mint[m batch[00;00m,[m [00;32mint[m deviceId[00;00m)[m
[00;00m{[m
    [00;32minit[m[00;00m([mcfgfile[00;00m,[m weightfile[00;00m,[m batch[00;00m,[m deviceId[00;00m);[m 
[00;00m}[m

[00;32mYOLO_Batch[m[00;00m::~[m[00;32mYOLO_Batch[m[00;00m()[m
[00;00m{[m
    [00;32mrelease[m[00;00m();[m 
[00;00m}[m

[00;32mstruct[m detector_gpu_t
[00;00m{[m
    network net[00;00m;[m 
    [00;34m// image images[BATCH]; [m
    [00;34m// float* avg; [m
    [00;34m// float* predictions[BATCH]; [m
    [00;34m// int demo_index; // used for temporal meanning [m
    [00;34m// unsigned int* track_id; [m
[00;00m};[m 


[00;32mint[m [00;32mYOLO_Batch[m[00;00m::[m[00;32minit[m[00;00m([m[00;32mstd[m[00;00m::[mstring cfgfile[00;00m,[m
                     [00;32mstd[m[00;00m::[mstring weightfile[00;00m,[m
                     [00;32mint[m batch[00;00m,[m 
                     [00;32mint[m deviceId[00;00m)[m
[00;00m{[m
    m_currDeviceId [00;00m=[m deviceId[00;00m;[m 

    [00;33mif[m[00;00m([mm_currDeviceId [00;00m>=[m[00;34m0[m [00;00m)[m
        [00;32mcuda_set_device[m[00;00m([mm_currDeviceId[00;00m);[m 

    [00;34m// init shared pointer [m
    m_detector_gpu_ptr [00;00m=[m [00;32mstd[m[00;00m::[mmake_shared[00;00m<[mdetector_gpu_t[00;00m>();[m 
    detector_gpu_t [00;00m&[mdetector_gpu [00;00m= *[m[00;33mstatic_cast[m[00;00m<[mdetector_gpu_t[00;00m*>([mm_detector_gpu_ptr[00;00m.[m[00;32mget[m[00;00m());[m 
    
    network [00;00m&[mnet [00;00m=[m detector_gpu[00;00m.[mnet[00;00m;[m 
    net[00;00m.[mgpu_index [00;00m=[m m_currDeviceId[00;00m;[m 
    [00;32mstd[m[00;00m::[mcout [00;00m<<[m [00;31m"Used GPU: "[m [00;00m<<[m m_currDeviceId [00;00m<<[m [00;32mstd[m[00;00m::[mendl[00;00m;[m 
    [00;32mchar[m[00;00m*[m c_cfg [00;00m=[m [00;33mconst_cast[m[00;00m<[m[00;32mchar[m[00;00m*>([mcfgfile[00;00m.[m[00;32mdata[m[00;00m());[m 
    [00;32mchar[m[00;00m*[m c_weight [00;00m=[m [00;33mconst_cast[m[00;00m<[m[00;32mchar[m[00;00m*>([mweightfile[00;00m.[m[00;32mdata[m[00;00m());[m 

    net [00;00m=[m [00;32mparse_network_cfg_custom[m[00;00m([mc_cfg[00;00m,[mbatch[00;00m);[m  
    [00;33mif[m[00;00m([mc_weight[00;00m)[m
    [00;00m{[m
        [00;32mload_weights[m[00;00m(&[mnet[00;00m,[m c_weight[00;00m);[m 
    [00;00m}[m
    [00;32mset_batch_network[m[00;00m(&[mnet[00;00m,[m batch[00;00m);[m  [00;34m// set batch  [m
    net[00;00m.[mgpu_index [00;00m=[m m_currDeviceId[00;00m;[m 
    [00;32mfuse_conv_batchnorm[m[00;00m([mnet[00;00m);[m 

    [00;34m// layer l = net.layers[net.n-1]; //get last layer[m
    [00;34m// int j;[m

    [00;34m// detector_gpu.avg = (float*)calloc(l.outputs, sizeof(float)); [m
    [00;34m// if(detector_gpu.avg == NULL)std::cout << "detector_gpu.avg calloc failed!" << std::endl; [m
    [00;34m// for(j=0;j<BATCH;++j) detector_gpu.predictions[j] = (float*)calloc(l.outputs, sizeof(float)); [m
    [00;34m// for(j=0;j<BATCH;++j) detector_gpu.images[j] = make_image(1,1,3); [m

    [00;34m// init other variables [m
    m_nms [00;00m=[m [00;34m0.4[m[00;00m;[m 
    m_waitStream [00;00m=[m [00;33mfalse[m[00;00m;[m 
    m_batchsize [00;00m=[m batch[00;00m;[m 
    m_detectType [00;00m=[m [00;34m0[m[00;00m;[m   [00;34m// default region type[m
    [00;33mreturn[m [00;34m0[m[00;00m;[m
[00;00m}[m

[00;32mvoid[m [00;32mYOLO_Batch[m[00;00m::[m[00;32mrelease[m[00;00m()[m
[00;00m{[m

[00;00m}[m

[00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m [00;32mYOLO_Batch[m[00;00m::[m[00;32mdetect_si[m[00;00m([mimage_t img[00;00m,[m [00;32mfloat[m thresh[00;00m,[m [00;32mbool[m use_mean[00;00m)[m
[00;00m{[m
    detector_gpu_t [00;00m&[mdetector_gpu [00;00m= *[m[00;33mstatic_cast[m[00;00m<[mdetector_gpu_t[00;00m*>([mm_detector_gpu_ptr[00;00m.[m[00;32mget[m[00;00m());[m
    network [00;00m&[mnet [00;00m=[m detector_gpu[00;00m.[mnet[00;00m;[m 
    [00;32mint[m old_gpu_index [00;00m=[m [00;32mcuda_get_device[m[00;00m();[m  [00;34m// save old gpu index for restoration[m
    [00;33mif[m[00;00m([mm_currDeviceId[00;00m>=[m[00;34m0[m [00;00m&&[m m_currDeviceId [00;00m!=[m old_gpu_index[00;00m)[m [00;32mcuda_set_device[m[00;00m([mnet[00;00m.[mgpu_index[00;00m);[m 

    net[00;00m.[mwait_stream [00;00m=[m m_waitStream[00;00m;[m  [00;34m// 1 - wait CUDA-stream, 0 - not to wait [m
    
    image im[00;00m;[m 
    im[00;00m.[mc [00;00m=[m img[00;00m.[mc[00;00m;[m 
    im[00;00m.[mdata [00;00m=[m img[00;00m.[mdata[00;00m;[m 
    im[00;00m.[mh [00;00m=[m img[00;00m.[mh[00;00m;[m 
    im[00;00m.[mw [00;00m=[m img[00;00m.[mw[00;00m;[m 

    image sized[00;00m;[m 
    [00;33mif[m[00;00m([mnet[00;00m.[mw [00;00m==[m im[00;00m.[mw [00;00m&&[m net[00;00m.[mh [00;00m==[m im[00;00m.[mh[00;00m)[m
    [00;00m{[m
        sized [00;00m=[m [00;32mmake_image[m[00;00m([mim[00;00m.[mw[00;00m,[m im[00;00m.[mh[00;00m,[m im[00;00m.[mc[00;00m);[m 
        [00;32mmemcpy[m[00;00m([msized[00;00m.[mdata[00;00m,[m im[00;00m.[mdata[00;00m,[m im[00;00m.[mw[00;00m*[mim[00;00m.[mh[00;00m*[mim[00;00m.[mc [00;00m*[m [00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m));[m 
    [00;00m}[m
    [00;33melse[m sized [00;00m=[m [00;32mresize_image[m[00;00m([mim[00;00m,[m net[00;00m.[mw[00;00m,[m net[00;00m.[mh[00;00m);[m 
    layer l [00;00m=[m net[00;00m.[mlayers[00;00m[[mnet[00;00m.[mn[00;00m-[m[00;34m1[m[00;00m];[m 
    [00;32mfloat[m[00;00m*[m X [00;00m=[m sized[00;00m.[mdata[00;00m;[m 
    [00;34m// float* prediction = network_predict(net, X); [m
    [00;32mnetwork_predict[m[00;00m([mnet[00;00m,[m X[00;00m);[m 

    [00;34m// if (use_mean) {[m
    [00;34m//     memcpy(detector_gpu.predictions[detector_gpu.demo_index], prediction, l.outputs * sizeof(float));[m
    [00;34m//     mean_arrays(detector_gpu.predictions, FRAMES, l.outputs, detector_gpu.avg);[m
    [00;34m//     l.output = detector_gpu.avg;[m
    [00;34m//     detector_gpu.demo_index = (detector_gpu.demo_index + 1) % FRAMES;[m
    [00;34m// }[m

    [00;34m// interpret results[m
    [00;32mint[m nboxes [00;00m=[m [00;34m0[m[00;00m;[m 
    [00;32mint[m letterbox [00;00m=[m [00;34m0[m[00;00m;[m 
    [00;32mfloat[m hier_thresh [00;00m=[m [00;34m0.5[m[00;00m;[m 
    detection[00;00m*[m dets [00;00m=[m [00;32mget_network_boxes[m[00;00m(&[mnet[00;00m,[m im[00;00m.[mw[00;00m,[m im[00;00m.[mh[00;00m,[m thresh[00;00m,[m hier_thresh[00;00m,[m [00;34m0[m[00;00m,[m[00;34m1[m[00;00m,&[mnboxes[00;00m,[m letterbox[00;00m);[m 
    [00;34m// std::cout << "before nms: " << nboxes << std::endl; [m
    [00;32mdo_nms_sort[m[00;00m([mdets[00;00m,[m nboxes[00;00m,[m l[00;00m.[mclasses[00;00m,[m m_nms[00;00m);[m [00;34m// clean non-object and overlap boxes; real objects num may smaller than nboxes [m

    [00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m bbox_vec[00;00m;[m 

    [00;33mfor[m [00;00m([m[00;32mint[m i[00;00m=[m[00;34m0[m[00;00m;[mi[00;00m<[mnboxes[00;00m;++[mi[00;00m)[m
    [00;00m{[m
        box b [00;00m=[m dets[00;00m[[mi[00;00m].[mbbox[00;00m;[m  [00;34m// TODO: what's the dimension here? [m
        [00;32mconst int[m obj_id [00;00m=[m [00;32mmax_index[m[00;00m([mdets[00;00m[[mi[00;00m].[mprob[00;00m,[m l[00;00m.[mclasses[00;00m);[m 
        [00;32mconst float[m prob [00;00m=[m dets[00;00m[[mi[00;00m].[mprob[00;00m[[mobj_id[00;00m];[m
        [00;34m// std::cout << "prob " << std::setw(2) << i << " :" << prob << std::endl; [m
        [00;33mif[m[00;00m([mprob [00;00m>[m thresh[00;00m)[m
        [00;00m{[m
            bbox_t bbox[00;00m;[m 

            bbox[00;00m.[mx [00;00m=[m [00;32mstd[m[00;00m::[m[00;32mmax[m[00;00m(([m[00;32mdouble[m[00;00m)[m[00;34m0[m[00;00m, ([mb[00;00m.[mx [00;00m-[m b[00;00m.[mw[00;00m/[m[00;34m2[m[00;00m.)*[mim[00;00m.[mw[00;00m);[m 
            bbox[00;00m.[my [00;00m=[m [00;32mstd[m[00;00m::[m[00;32mmax[m[00;00m(([m[00;32mdouble[m[00;00m)[m[00;34m0[m[00;00m, ([mb[00;00m.[my [00;00m-[m b[00;00m.[mh[00;00m/[m[00;34m2[m[00;00m.)*[mim[00;00m.[mh[00;00m);[m 
            bbox[00;00m.[mw [00;00m=[m b[00;00m.[mw[00;00m*[mim[00;00m.[mw[00;00m;[m 
            bbox[00;00m.[mh [00;00m=[m b[00;00m.[mh[00;00m*[mim[00;00m.[mh[00;00m;[m
            bbox[00;00m.[mobj_id [00;00m=[m obj_id[00;00m;[m 
            bbox[00;00m.[mprob [00;00m=[m prob[00;00m;[m 
            bbox[00;00m.[mtrack_id [00;00m=[m [00;34m0[m[00;00m;[m 
            bbox_vec[00;00m.[m[00;32mpush_back[m[00;00m([mbbox[00;00m);[m 
        [00;00m}[m
    [00;00m}[m

    [00;32mfree_detections[m[00;00m([mdets[00;00m,[m nboxes[00;00m);[m 
    [00;33mif[m[00;00m([msized[00;00m.[mdata[00;00m)[m [00;32mfree[m[00;00m([msized[00;00m.[mdata[00;00m);[m 

    [00;33mif[m[00;00m([mm_currDeviceId [00;00m!=[m old_gpu_index[00;00m)[m[00;32mcuda_set_device[m[00;00m([mold_gpu_index[00;00m);[m 

    [00;33mreturn[m bbox_vec[00;00m;[m 
[00;00m}[m



[00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m [00;32mYOLO_Batch[m[00;00m::[m[00;32mdetect_si_region[m[00;00m([mimage_t img[00;00m,[m [00;32mfloat[m thresh[00;00m,[m [00;32mbool[m use_mean[00;00m)[m
[00;00m{[m
    detector_gpu_t [00;00m&[mdetector_gpu [00;00m= *[m[00;33mstatic_cast[m[00;00m<[mdetector_gpu_t[00;00m*>([mm_detector_gpu_ptr[00;00m.[m[00;32mget[m[00;00m());[m
    network [00;00m&[mnet [00;00m=[m detector_gpu[00;00m.[mnet[00;00m;[m 
    [00;32mint[m old_gpu_index [00;00m=[m [00;32mcuda_get_device[m[00;00m();[m  [00;34m// save old gpu index for restoration[m
    [00;33mif[m[00;00m([mm_currDeviceId [00;00m>=[m[00;34m0[m [00;00m&&[m m_currDeviceId [00;00m!=[m old_gpu_index[00;00m)[m [00;32mcuda_set_device[m[00;00m([mnet[00;00m.[mgpu_index[00;00m);[m 

    net[00;00m.[mwait_stream [00;00m=[m m_waitStream[00;00m;[m  [00;34m// 1 - wait CUDA-stream, 0 - not to wait [m
    
    image im[00;00m;[m 
    im[00;00m.[mc [00;00m=[m img[00;00m.[mc[00;00m;[m 
    im[00;00m.[mdata [00;00m=[m img[00;00m.[mdata[00;00m;[m 
    im[00;00m.[mh [00;00m=[m img[00;00m.[mh[00;00m;[m 
    im[00;00m.[mw [00;00m=[m img[00;00m.[mw[00;00m;[m 

    image sized[00;00m;[m 
    [00;33mif[m[00;00m([mnet[00;00m.[mw [00;00m==[m im[00;00m.[mw [00;00m&&[m net[00;00m.[mh [00;00m==[m im[00;00m.[mh[00;00m)[m
    [00;00m{[m
        sized [00;00m=[m [00;32mmake_image[m[00;00m([mim[00;00m.[mw[00;00m,[m im[00;00m.[mh[00;00m,[m im[00;00m.[mc[00;00m);[m 
        [00;32mmemcpy[m[00;00m([msized[00;00m.[mdata[00;00m,[m im[00;00m.[mdata[00;00m,[m im[00;00m.[mw[00;00m*[mim[00;00m.[mh[00;00m*[mim[00;00m.[mc [00;00m*[m [00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m));[m 
    [00;00m}[m
    [00;33melse[m sized [00;00m=[m [00;32mresize_image[m[00;00m([mim[00;00m,[m net[00;00m.[mw[00;00m,[m net[00;00m.[mh[00;00m);[m 

    layer l [00;00m=[m net[00;00m.[mlayers[00;00m[[mnet[00;00m.[mn[00;00m-[m[00;34m1[m[00;00m];[m 
    [00;32mfloat[m[00;00m*[m X [00;00m=[m sized[00;00m.[mdata[00;00m;[m 
    [00;34m// float* prediction = network_predict(net, X); [m
    [00;32mnetwork_predict[m[00;00m([mnet[00;00m,[m X[00;00m);[m 

    [00;34m// interpret results[m
    [00;34m// detection* dets = get_network_boxes(&net, im.w, im.h, thresh, hier_thresh, 0,1,&nboxes, letterbox); [m
    box[00;00m*[m boxes [00;00m= ([mbox[00;00m*)[m[00;32mcalloc[m[00;00m([ml[00;00m.[mw [00;00m*[m l[00;00m.[mh [00;00m*[m l[00;00m.[mn[00;00m,[m [00;33msizeof[m[00;00m([mbox[00;00m));[m 
    [00;32mfloat[m [00;00m**[mprobs [00;00m= ([m[00;32mfloat[m[00;00m**)[m[00;32mcalloc[m[00;00m([ml[00;00m.[mw[00;00m*[ml[00;00m.[mh[00;00m*[ml[00;00m.[mh[00;00m,[m [00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m*));[m 
    [00;33mfor[m[00;00m([m[00;32mint[m k[00;00m=[m[00;34m0[m[00;00m;[mk[00;00m<[ml[00;00m.[mw[00;00m*[ml[00;00m.[mh[00;00m*[ml[00;00m.[mn[00;00m;[mk[00;00m++)[mprobs[00;00m[[mk[00;00m]=([m[00;32mfloat[m[00;00m*)[m[00;32mcalloc[m[00;00m([ml[00;00m.[mclasses[00;00m,[m [00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m*));[m 
    
    [00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m bbox_vec[00;00m;[m 

    [00;32mget_region_boxes[m[00;00m([ml[00;00m,[m [00;34m1[m[00;00m,[m[00;34m1[m[00;00m,[mthresh[00;00m,[m probs[00;00m,[m boxes[00;00m,[m [00;34m0[m[00;00m,[m[00;34m0[m[00;00m);[m 
    [00;32mdo_nms[m[00;00m([mboxes[00;00m,[m probs[00;00m,[ml[00;00m.[mw[00;00m*[ml[00;00m.[mh[00;00m*[ml[00;00m.[mn[00;00m,[m l[00;00m.[mclasses[00;00m,[m m_nms[00;00m);[m 

    [00;33mfor[m [00;00m([m[00;32mint[m k[00;00m=[m[00;34m0[m[00;00m;[mk[00;00m<[ml[00;00m.[mw[00;00m*[ml[00;00m.[mh[00;00m*[ml[00;00m.[mn[00;00m;++[mk[00;00m)[m
    [00;00m{[m
        box b [00;00m=[m boxes[00;00m[[mk[00;00m];[m 
        [00;32mconst int[m obj_id [00;00m=[m [00;32mmax_index[m[00;00m([mprobs[00;00m[[mk[00;00m],[m l[00;00m.[mclasses[00;00m);[m 
        [00;32mconst float[m prob [00;00m=[m probs[00;00m[[mk[00;00m][[mobj_id[00;00m];[m 
        [00;33mif[m[00;00m([mprob [00;00m>[m thresh[00;00m)[m
        [00;00m{[m
            bbox_t bbox[00;00m;[m 
            bbox[00;00m.[mx [00;00m=[m [00;32mstd[m[00;00m::[m[00;32mmax[m[00;00m(([m[00;32mdouble[m[00;00m)[m[00;34m0[m[00;00m, ([mb[00;00m.[mx [00;00m-[m b[00;00m.[mw[00;00m/[m[00;34m2[m[00;00m.)*[mim[00;00m.[mw[00;00m);[m 
            bbox[00;00m.[my [00;00m=[m [00;32mstd[m[00;00m::[m[00;32mmax[m[00;00m(([m[00;32mdouble[m[00;00m)[m[00;34m0[m[00;00m, ([mb[00;00m.[my [00;00m-[m b[00;00m.[mh[00;00m/[m[00;34m2[m[00;00m.)*[mim[00;00m.[mh[00;00m);[m 
            bbox[00;00m.[mw [00;00m=[m b[00;00m.[mw[00;00m*[mim[00;00m.[mw[00;00m;[m 
            bbox[00;00m.[mh [00;00m=[m b[00;00m.[mh[00;00m*[mim[00;00m.[mh[00;00m;[m
            bbox[00;00m.[mobj_id [00;00m=[m obj_id[00;00m;[m 
            bbox[00;00m.[mprob [00;00m=[m prob[00;00m;[m 
            bbox[00;00m.[mtrack_id [00;00m=[m [00;34m0[m[00;00m;[m 

            bbox_vec[00;00m.[m[00;32mpush_back[m[00;00m([mbbox[00;00m);[m 
        [00;00m}[m
    [00;00m}[m
    [00;32mfree[m[00;00m([mboxes[00;00m);[m 
    [00;32mfree_ptrs[m[00;00m(([m[00;32mvoid[m[00;00m**)[mprobs[00;00m,[m l[00;00m.[mw[00;00m*[ml[00;00m.[mh[00;00m*[ml[00;00m.[mn[00;00m);[m 
    [00;33mif[m[00;00m([msized[00;00m.[mdata[00;00m)[m [00;32mfree[m[00;00m([msized[00;00m.[mdata[00;00m);[m 


    [00;33mif[m[00;00m([mm_currDeviceId [00;00m!=[m old_gpu_index[00;00m)[m[00;32mcuda_set_device[m[00;00m([mold_gpu_index[00;00m);[m 

    [00;33mreturn[m bbox_vec[00;00m;[m 
[00;00m}[m


[00;32mstd[m[00;00m::[mshared_ptr[00;00m<[mimage_t[00;00m>[m [00;32mYOLO_Batch[m[00;00m::[m[00;32mmat_to_image_resize[m[00;00m([m[00;32mcv[m[00;00m::[mMat mat[00;00m)[m 
[00;00m{[m
    [00;33mif[m [00;00m([mmat[00;00m.[mdata [00;00m==[m NULL[00;00m)[m [00;33mreturn[m [00;32mstd[m[00;00m::[mshared_ptr[00;00m<[mimage_t[00;00m>([mNULL[00;00m);[m

    [00;32mcv[m[00;00m::[mSize network_size [00;00m=[m [00;32mcv[m[00;00m::[m[00;32mSize[m[00;00m([m[00;32mget_net_width[m[00;00m(),[m [00;32mget_net_height[m[00;00m());[m
    [00;32mcv[m[00;00m::[mMat det_mat[00;00m;[m
    [00;33mif[m [00;00m([mmat[00;00m.[m[00;32msize[m[00;00m() !=[m network_size[00;00m)[m
        [00;32mcv[m[00;00m::[m[00;32mresize[m[00;00m([mmat[00;00m,[m det_mat[00;00m,[m network_size[00;00m);[m
    [00;33melse[m
        det_mat [00;00m=[m mat[00;00m;[m  [00;34m// only reference is copied[m

    [00;32mauto[m img [00;00m=[m [00;32mmat_to_image[m[00;00m([mdet_mat[00;00m);[m 
    [00;33mreturn[m img[00;00m;[m 
[00;00m}[m

[00;32mstd[m[00;00m::[mshared_ptr[00;00m<[mimage_t[00;00m>[m [00;32mYOLO_Batch[m[00;00m::[m[00;32mmat_to_image[m[00;00m([m[00;32mcv[m[00;00m::[mMat img_src[00;00m)[m
[00;00m{[m
    [00;32mcv[m[00;00m::[mMat img[00;00m;[m
    [00;32mcv[m[00;00m::[m[00;32mcvtColor[m[00;00m([mimg_src[00;00m,[m img[00;00m,[m [00;32mcv[m[00;00m::[mCOLOR_RGB2BGR[00;00m);[m
    [00;32mstd[m[00;00m::[mshared_ptr[00;00m<[mimage_t[00;00m>[m [00;32mimage_ptr[m[00;00m([m[00;33mnew[m image_t[00;00m, [[m[00;33mthis[m[00;00m]([mimage_t [00;00m*[mim[00;00m) {[m [00;32mfree_image[m[00;00m(*[mim[00;00m);[m [00;33mdelete[m im[00;00m; });[m
    [00;32mstd[m[00;00m::[mshared_ptr[00;00m<[mIplImage[00;00m>[m ipl_small [00;00m=[m [00;32mstd[m[00;00m::[mmake_shared[00;00m<[mIplImage[00;00m>([mimg[00;00m);[m
    [00;00m*[mimage_ptr [00;00m=[m [00;32mipl_to_image[m[00;00m([mipl_small[00;00m.[m[00;32mget[m[00;00m());[m
    [00;33mreturn[m image_ptr[00;00m;[m
[00;00m}[m

image_t [00;32mYOLO_Batch[m[00;00m::[m[00;32mipl_to_image[m[00;00m([mIplImage[00;00m*[m src[00;00m)[m
[00;00m{[m
    [00;32munsigned char[m [00;00m*[mdata [00;00m= ([m[00;32munsigned char[m [00;00m*)[msrc[00;00m->[mimageData[00;00m;[m
    [00;32mint[m h [00;00m=[m src[00;00m->[mheight[00;00m;[m
    [00;32mint[m w [00;00m=[m src[00;00m->[mwidth[00;00m;[m
    [00;32mint[m c [00;00m=[m src[00;00m->[mnChannels[00;00m;[m
    [00;32mint[m step [00;00m=[m src[00;00m->[mwidthStep[00;00m;[m
    image_t out [00;00m=[m [00;32mmake_image_custom[m[00;00m([mw[00;00m,[m h[00;00m,[m c[00;00m);[m
    [00;32mint[m count [00;00m=[m [00;34m0[m[00;00m;[m

    [00;33mfor[m [00;00m([m[00;32mint[m k [00;00m=[m [00;34m0[m[00;00m;[m k [00;00m<[m c[00;00m; ++[mk[00;00m) {[m
        [00;33mfor[m [00;00m([m[00;32mint[m i [00;00m=[m [00;34m0[m[00;00m;[m i [00;00m<[m h[00;00m; ++[mi[00;00m) {[m
            [00;32mint[m i_step [00;00m=[m i[00;00m*[mstep[00;00m;[m
            [00;33mfor[m [00;00m([m[00;32mint[m j [00;00m=[m [00;34m0[m[00;00m;[m j [00;00m<[m w[00;00m; ++[mj[00;00m) {[m
                out[00;00m.[mdata[00;00m[[mcount[00;00m++] =[m data[00;00m[[mi_step [00;00m+[m j[00;00m*[mc [00;00m+[m k[00;00m] /[m [00;34m255[m[00;00m.;[m
            [00;00m}[m
        [00;00m}[m
    [00;00m}[m

    [00;33mreturn[m out[00;00m;[m
[00;00m}[m

image_t [00;32mYOLO_Batch[m[00;00m::[m[00;32mmake_empty_image[m[00;00m([m[00;32mint[m w[00;00m,[m [00;32mint[m h[00;00m,[m [00;32mint[m c[00;00m)[m
[00;00m{[m
    image_t out[00;00m;[m
    out[00;00m.[mdata [00;00m=[m [00;34m0[m[00;00m;[m
    out[00;00m.[mh [00;00m=[m h[00;00m;[m
    out[00;00m.[mw [00;00m=[m w[00;00m;[m
    out[00;00m.[mc [00;00m=[m c[00;00m;[m
    [00;33mreturn[m out[00;00m;[m
[00;00m}[m

image_t [00;32mYOLO_Batch[m[00;00m::[m[00;32mmake_image_custom[m[00;00m([m[00;32mint[m w[00;00m,[m [00;32mint[m h[00;00m,[m [00;32mint[m c[00;00m)[m
[00;00m{[m
    image_t out [00;00m=[m [00;32mmake_empty_image[m[00;00m([mw[00;00m,[m h[00;00m,[m c[00;00m);[m
    out[00;00m.[mdata [00;00m= ([m[00;32mfloat[m [00;00m*)[m[00;32mcalloc[m[00;00m([mh[00;00m*[mw[00;00m*[mc[00;00m,[m [00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m));[m
    [00;33mreturn[m out[00;00m;[m
[00;00m}[m

[00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m [00;32mYOLO_Batch[m[00;00m::[m[00;32mdetect_resized_si[m[00;00m([m
    image_t img_resized[00;00m,[m 
    [00;32mint[m init_w[00;00m,[m 
    [00;32mint[m init_h[00;00m,[m 
    [00;32mfloat[m thresh[00;00m,[m 
    [00;32mbool[m use_mean[00;00m)[m
[00;00m{[m
    [00;33mif[m[00;00m([mimg_resized[00;00m.[mdata [00;00m==[m NULL[00;00m)[m[00;33mthrow[m [00;32mstd[m[00;00m::[m[00;32mruntime_error[m[00;00m([m[00;31m"Image is empty"[m[00;00m);[m 
    [00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m bboxes[00;00m;[m 
    [00;33mif[m[00;00m([mm_detectType [00;00m==[m [00;34m1[m[00;00m)[m
        bboxes [00;00m=[m [00;32mdetect_si[m[00;00m([mimg_resized[00;00m,[m thresh[00;00m,[m use_mean[00;00m);[m 
    [00;33melse[m bboxes [00;00m=[m [00;32mdetect_si_region[m[00;00m([mimg_resized[00;00m,[m thresh[00;00m,[m use_mean[00;00m);[m 
    [00;32mfloat[m wk [00;00m= ([m[00;32mfloat[m[00;00m)[minit_w [00;00m/[m img_resized[00;00m.[mw[00;00m;[m
    [00;32mfloat[m hk [00;00m= ([m[00;32mfloat[m[00;00m)[minit_h [00;00m/[m img_resized[00;00m.[mh[00;00m;[m
    [00;33mfor[m[00;00m([m[00;32mauto[m [00;00m&[mbbox[00;00m:[m bboxes[00;00m) {[m
        bbox[00;00m.[mx [00;00m*=[m wk[00;00m;[m 
        bbox[00;00m.[mw [00;00m*=[m wk[00;00m;[m 
        bbox[00;00m.[my [00;00m*=[m hk[00;00m;[m
        bbox[00;00m.[mh [00;00m*=[m hk[00;00m;[m
    [00;00m}[m
    [00;33mreturn[m bboxes[00;00m;[m 
[00;00m}[m

[00;32mint[m [00;32mYOLO_Batch[m[00;00m::[m[00;32mget_net_height[m[00;00m()[m [00;32mconst[m 
[00;00m{[m
    detector_gpu_t [00;00m&[mdetector_gpu [00;00m= *[m[00;33mstatic_cast[m[00;00m<[mdetector_gpu_t[00;00m*>([mm_detector_gpu_ptr[00;00m.[m[00;32mget[m[00;00m());[m 
    [00;33mreturn[m detector_gpu[00;00m.[mnet[00;00m.[mh[00;00m;[m 
[00;00m}[m

[00;32mint[m [00;32mYOLO_Batch[m[00;00m::[m[00;32mget_net_width[m[00;00m()[m [00;32mconst[m 
[00;00m{[m
    detector_gpu_t [00;00m&[mdetector_gpu [00;00m= *[m[00;33mstatic_cast[m[00;00m<[mdetector_gpu_t[00;00m*>([mm_detector_gpu_ptr[00;00m.[m[00;32mget[m[00;00m());[m 
    [00;33mreturn[m detector_gpu[00;00m.[mnet[00;00m.[mw[00;00m;[m 
[00;00m}[m

[00;32mvoid[m [00;32mYOLO_Batch[m[00;00m::[m[00;32mfree_image[m[00;00m([mimage_t m[00;00m)[m
[00;00m{[m
    [00;33mif[m[00;00m([mm[00;00m.[mdata[00;00m)[m [00;32mfree[m[00;00m([mm[00;00m.[mdata[00;00m);[m 
[00;00m}[m

[00;32mstd[m[00;00m::[mvector[00;00m<[m[00;32mstd[m[00;00m::[mstring[00;00m>[m [00;32mYOLO_Batch[m[00;00m::[m[00;32mload_object_names[m[00;00m([m[00;32mstd[m[00;00m::[mstring filename[00;00m)[m
[00;00m{[m
    [00;32mstd[m[00;00m::[mifstream [00;32mnamefile[m[00;00m([mfilename[00;00m);[m 
    [00;32mstd[m[00;00m::[mvector[00;00m<[m[00;32mstd[m[00;00m::[mstring[00;00m>[m names[00;00m;[m 
    [00;33mif[m[00;00m(![mnamefile[00;00m.[m[00;32mis_open[m[00;00m())[m 
    [00;00m{[m
        [00;32mstd[m[00;00m::[mcout [00;00m<<[m [00;31m"cannot open "[m [00;00m<<[m filename [00;00m<<[m [00;32mstd[m[00;00m::[mendl[00;00m;[m 
        [00;33mreturn[m names[00;00m;[m 
    [00;00m}[m

    [00;33mfor[m[00;00m([m[00;32mstd[m[00;00m::[mstring line[00;00m;[m [00;32mgetline[m[00;00m([mnamefile[00;00m,[m line[00;00m);)[mnames[00;00m.[m[00;32mpush_back[m[00;00m([mline[00;00m);[m 

    [00;33mreturn[m names[00;00m;[m 
[00;00m}[m

[00;32mcv[m[00;00m::[mMat [00;32mYOLO_Batch[m[00;00m::[m[00;32mdraw_boxes[m[00;00m([m
    [00;32mcv[m[00;00m::[mMat mat_img[00;00m,[m
	[00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m result_vec[00;00m,[m 
    [00;32mstd[m[00;00m::[mvector[00;00m<[m[00;32mstd[m[00;00m::[mstring[00;00m>[m obj_names[00;00m)[m 
[00;00m{[m
	[00;32mcv[m[00;00m::[mMat visualImg [00;00m=[m mat_img[00;00m.[m[00;32mclone[m[00;00m();[m
	[00;32mint const[m colors[00;00m[[m[00;34m6[m[00;00m][[m[00;34m3[m[00;00m] = { {[m [00;34m1[m[00;00m,[m[00;34m0[m[00;00m,[m[00;34m1[m [00;00m},{[m [00;34m0[m[00;00m,[m[00;34m0[m[00;00m,[m[00;34m1[m [00;00m},{[m [00;34m0[m[00;00m,[m[00;34m1[m[00;00m,[m[00;34m1[m [00;00m},{[m [00;34m0[m[00;00m,[m[00;34m1[m[00;00m,[m[00;34m0[m [00;00m},{[m [00;34m1[m[00;00m,[m[00;34m1[m[00;00m,[m[00;34m0[m [00;00m},{[m [00;34m1[m[00;00m,[m[00;34m0[m[00;00m,[m[00;34m0[m [00;00m} };[m
	[00;33mfor[m [00;00m([m[00;32mauto[m [00;00m&[mi [00;00m:[m result_vec[00;00m) {[m
		[00;33mif[m [00;00m([mi[00;00m.[mprob [00;00m<[m [00;34m0.5[m [00;00m||[m obj_names[00;00m[[mi[00;00m.[mobj_id[00;00m]!=[m[00;31m"person"[m[00;00m)[m [00;34m// just show person [m
			[00;33mcontinue[m[00;00m;[m
		[00;32mint const[m offset [00;00m=[m i[00;00m.[mobj_id [00;00m*[m [00;34m123457[m [00;00m%[m [00;34m6[m[00;00m;[m
		[00;32mint const[m color_scale [00;00m=[m [00;34m150[m [00;00m+ ([mi[00;00m.[mobj_id [00;00m*[m [00;34m123457[m[00;00m) %[m [00;34m100[m[00;00m;[m
		[00;32mcv[m[00;00m::[mScalar [00;32mcolor[m[00;00m([mcolors[00;00m[[moffset[00;00m][[m[00;34m0[m[00;00m],[m colors[00;00m[[moffset[00;00m][[m[00;34m1[m[00;00m],[m colors[00;00m[[moffset[00;00m][[m[00;34m2[m[00;00m]);[m
		color [00;00m*=[m color_scale[00;00m;[m
		[00;32mcv[m[00;00m::[m[00;32mrectangle[m[00;00m([mvisualImg[00;00m,[m [00;32mcv[m[00;00m::[m[00;32mRect[m[00;00m([mi[00;00m.[mx[00;00m,[m i[00;00m.[my[00;00m,[m i[00;00m.[mw[00;00m,[m i[00;00m.[mh[00;00m),[m color[00;00m,[m [00;34m3[m[00;00m);[m
		[00;33mif[m [00;00m([mobj_names[00;00m.[m[00;32msize[m[00;00m() >[m i[00;00m.[mobj_id[00;00m) {[m
			[00;32mstd[m[00;00m::[mstring obj_name [00;00m=[m obj_names[00;00m[[mi[00;00m.[mobj_id[00;00m];[m
			[00;34m// if (i.track_id > 0) obj_name += " - " + std::to_string(i.track_id); // no track now[m
			[00;32mconst[m [00;32mcv[m[00;00m::[mSize text_size [00;00m=[m [00;32mgetTextSize[m[00;00m([mobj_name[00;00m,[m [00;32mcv[m[00;00m::[mFONT_HERSHEY_COMPLEX_SMALL[00;00m,[m [00;34m0.6[m[00;00m,[m [00;34m1[m[00;00m,[m [00;34m0[m[00;00m);[m
			[00;32mint const[m max_width [00;00m= ([mtext_size[00;00m.[mwidth [00;00m> ([m[00;32mint[m[00;00m)[mi[00;00m.[mw[00;00m) ?[m text_size[00;00m.[mwidth [00;00m: ([mi[00;00m.[mw[00;00m);[m
			[00;32mcv[m[00;00m::[m[00;32mrectangle[m[00;00m([mvisualImg[00;00m,[m [00;32mcv[m[00;00m::[m[00;32mPoint2f[m[00;00m([m[00;32mstd[m[00;00m::[mmax[00;00m<[m[00;32mint[m[00;00m>(([m[00;32mint[m[00;00m)[mi[00;00m.[mx [00;00m-[m[00;34m3[m [00;00m,[m [00;34m0[m[00;00m),[m [00;34m// 3 is linewidth of bbox[m
                          [00;32mstd[m[00;00m::[mmax[00;00m<[m[00;32mint[m[00;00m>(([m[00;32mint[m[00;00m)[mi[00;00m.[my [00;00m-[m [00;34m17[m[00;00m,[m [00;34m0[m[00;00m)),[m[00;32mcv[m[00;00m::[m[00;32mPoint2f[m[00;00m([m[00;32mstd[m[00;00m::[mmin[00;00m<[m[00;32mint[m[00;00m>(([m[00;32mint[m[00;00m)[mi[00;00m.[mx [00;00m+[m max_width[00;00m,[m mat_img[00;00m.[mcols [00;00m-[m [00;34m1[m[00;00m),[m
					      [00;32mstd[m[00;00m::[mmin[00;00m<[m[00;32mint[m[00;00m>(([m[00;32mint[m[00;00m)[mi[00;00m.[my[00;00m,[m mat_img[00;00m.[mrows [00;00m-[m [00;34m1[m[00;00m)),[m
				          color[00;00m,[m CV_FILLED[00;00m,[m [00;34m1[m[00;00m,[m [00;34m0[m[00;00m);[m
			[00;32mputText[m[00;00m([mvisualImg[00;00m,[m obj_name[00;00m,[m [00;32mcv[m[00;00m::[m[00;32mPoint2f[m[00;00m([mi[00;00m.[mx[00;00m,[m i[00;00m.[my [00;00m-[m [00;34m8[m[00;00m),[m
				    [00;32mcv[m[00;00m::[mFONT_HERSHEY_COMPLEX_SMALL[00;00m,[m [00;34m0.6[m[00;00m,[m [00;32mcv[m[00;00m::[m[00;32mScalar[m[00;00m([m[00;34m255[m[00;00m,[m [00;34m255[m[00;00m,[m [00;34m255[m[00;00m),[m [00;34m1[m[00;00m);[m
		[00;00m}[m
	[00;00m}[m
	[00;33mreturn[m visualImg[00;00m;[m
[00;00m}[m

[00;32mvoid[m [00;32mYOLO_Batch[m[00;00m::[m[00;32msave_image_t_[m[00;00m([mimage_t[00;00m&[m img[00;00m,[m [00;32mconst char[m[00;00m*[m name [00;00m)[m
[00;00m{[m
    image temp[00;00m;[m
    temp[00;00m.[mc [00;00m=[m img[00;00m.[mc[00;00m;[mtemp[00;00m.[mw [00;00m=[m img[00;00m.[mw[00;00m;[mtemp[00;00m.[mh [00;00m=[m img[00;00m.[mh[00;00m;[mtemp[00;00m.[mdata[00;00m=[mimg[00;00m.[mdata[00;00m;[m
    [00;32msave_image[m[00;00m([mtemp[00;00m,[m name[00;00m);[m 
[00;00m}[m

[00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m [00;32mYOLO_Batch[m[00;00m::[m[00;32mdetect_mat_si[m[00;00m([m[00;32mcv[m[00;00m::[mMat img[00;00m,[m [00;32mfloat[m thresh[00;00m)[m
[00;00m{[m
    [00;33mif[m[00;00m([mimg[00;00m.[mdata [00;00m==[m NULL[00;00m)[m[00;33mthrow[m [00;32mstd[m[00;00m::[m[00;32mruntime_error[m[00;00m([m[00;31m"Image is empty"[m[00;00m);[m 
    [00;32mauto[m image_ptr [00;00m=[m [00;32mmat_to_image_resize[m[00;00m([mimg[00;00m);[m 
    [00;33mreturn[m [00;32mdetect_resized_si[m[00;00m(*[mimage_ptr[00;00m,[m img[00;00m.[mcols[00;00m,[m img[00;00m.[mrows[00;00m,[m thresh[00;00m,[m [00;33mfalse[m[00;00m);[m 
[00;00m}[m


[00;34m/*****************batch detection*******************/[m
[00;34m// Thanks to jstumpin at https://github.com/AlexeyAB/darknet/issues/878 [m
BoxesVec [00;32mYOLO_Batch[m[00;00m::[m[00;32mdetect_batch_region[m[00;00m([mImagePtrList img_ptrs[00;00m,[m [00;32mfloat[m thresh[00;00m)[m
[00;00m{[m
    detector_gpu_t[00;00m&[m detector_gpu [00;00m= *[m[00;33mstatic_cast[m[00;00m<[mdetector_gpu_t[00;00m*>([mm_detector_gpu_ptr[00;00m.[m[00;32mget[m[00;00m());[m
    network [00;00m&[mnet [00;00m=[m detector_gpu[00;00m.[mnet[00;00m;[m 
    [00;32mint[m old_gpu_index [00;00m=[m [00;32mcuda_get_device[m[00;00m();[m 
    [00;33mif[m[00;00m([mm_currDeviceId [00;00m>=[m[00;34m0[m [00;00m&&[m m_currDeviceId [00;00m!=[m old_gpu_index[00;00m)[m [00;32mcuda_set_device[m[00;00m([mnet[00;00m.[mgpu_index[00;00m);[m 
    net[00;00m.[mwait_stream [00;00m=[m m_waitStream[00;00m;[m 


    [00;34m// assume channel 3 [m
    [00;32mfloat[m [00;00m*[mX [00;00m= ([m[00;32mfloat[m[00;00m*)[m[00;32mcalloc[m[00;00m([mnet[00;00m.[mbatch[00;00m*[mnet[00;00m.[mw[00;00m*[mnet[00;00m.[mh[00;00m*[m[00;34m3[m[00;00m,[m[00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m));[m
    [00;33mfor[m[00;00m([m[00;32mint[m i[00;00m=[m[00;34m0[m[00;00m;[mi[00;00m<[mnet[00;00m.[mbatch[00;00m;[mi[00;00m++)[m
    [00;00m{[m
        image im[00;00m;[m 
        im[00;00m.[mc [00;00m=[m img_ptrs[00;00m[[mi[00;00m]->[mc[00;00m;[m
        im[00;00m.[mw [00;00m=[m img_ptrs[00;00m[[mi[00;00m]->[mw[00;00m;[m 
        im[00;00m.[mh [00;00m=[m img_ptrs[00;00m[[mi[00;00m]->[mh[00;00m;[m 
        im[00;00m.[mdata [00;00m=[m img_ptrs[00;00m[[mi[00;00m]->[mdata[00;00m;[m 
        image sized[00;00m;[m 
        [00;33mif[m[00;00m([mnet[00;00m.[mw[00;00m==[mim[00;00m.[mw [00;00m&&[m net[00;00m.[mh[00;00m==[mim[00;00m.[mh[00;00m)[m
        [00;00m{[m
            sized [00;00m=[m [00;32mmake_image[m[00;00m([mim[00;00m.[mw[00;00m,[mim[00;00m.[mh[00;00m,[mim[00;00m.[mc[00;00m);[m 
            [00;32mmemcpy[m[00;00m([msized[00;00m.[mdata[00;00m,[m im[00;00m.[mdata[00;00m,[m im[00;00m.[mw[00;00m*[mim[00;00m.[mh[00;00m*[mim[00;00m.[mc[00;00m*[m[00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m));[m 
        [00;00m}[m
        [00;33melse[m sized [00;00m=[m [00;32mresize_image[m[00;00m([mim[00;00m,[m net[00;00m.[mw[00;00m,[m net[00;00m.[mh[00;00m);[m 
        [00;32mmemcpy[m[00;00m([mX[00;00m+[mi[00;00m*[mnet[00;00m.[mh[00;00m*[mnet[00;00m.[mw[00;00m*[m[00;34m3[m[00;00m,[m sized[00;00m.[mdata[00;00m,[m net[00;00m.[mh[00;00m*[mnet[00;00m.[mw[00;00m*[m[00;34m3[m[00;00m*[m[00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m));[m 
        [00;32mfree[m[00;00m([msized[00;00m.[mdata[00;00m);[m 
    [00;00m}[m 

    [00;34m// predict [m
    [00;32mnetwork_predict[m[00;00m([mnet[00;00m,[m X[00;00m);[m 
    layer l [00;00m=[m net[00;00m.[mlayers[00;00m[[mnet[00;00m.[mn[00;00m-[m[00;34m1[m[00;00m];[m 



    [00;34m// get bbox[m
    BoxesVec bbox_vec_batch[00;00m;[m 
    [00;33mfor[m[00;00m([m[00;32mint[m j[00;00m=[m[00;34m0[m[00;00m;[mj[00;00m<[mnet[00;00m.[mbatch[00;00m;[mj[00;00m++)[m
    [00;00m{[m
        box[00;00m*[m boxes [00;00m= ([mbox[00;00m*)[m[00;32mcalloc[m[00;00m([ml[00;00m.[mw[00;00m*[ml[00;00m.[mh[00;00m*[ml[00;00m.[mn[00;00m,[m [00;33msizeof[m[00;00m([mbox[00;00m));[m [00;34m// so what is layer.n[m
        [00;32mfloat[m[00;00m**[m probs [00;00m= ([m[00;32mfloat[m[00;00m**)[m[00;32mcalloc[m[00;00m([ml[00;00m.[mw[00;00m*[ml[00;00m.[mh[00;00m*[ml[00;00m.[mn[00;00m,[m [00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m*));[m 
        [00;33mfor[m[00;00m([m[00;32mint[m j[00;00m=[m[00;34m0[m[00;00m;[mj[00;00m<[ml[00;00m.[mw[00;00m*[ml[00;00m.[mh[00;00m*[ml[00;00m.[mn[00;00m;[mj[00;00m++)[m
        [00;00m{[m
            probs[00;00m[[mj[00;00m] = ([m[00;32mfloat[m[00;00m*)[m[00;32mcalloc[m[00;00m([ml[00;00m.[mclasses[00;00m,[m [00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m));[m 
        [00;00m}[m
        Boxes bbox_vec[00;00m;[m 
        [00;32mget_region_boxes[m[00;00m([ml[00;00m,[m[00;34m1[m[00;00m,[m[00;34m1[m[00;00m,[mthresh[00;00m,[mprobs[00;00m,[mboxes[00;00m,[m [00;34m0[m[00;00m,[m [00;34m0[m[00;00m);[m 
        [00;32mdo_nms[m[00;00m([mboxes[00;00m,[m probs[00;00m,[m l[00;00m.[mw[00;00m*[ml[00;00m.[mh[00;00m*[ml[00;00m.[mn[00;00m,[m l[00;00m.[mclasses[00;00m,[m m_nms[00;00m);[m
        [00;33mfor[m[00;00m([m[00;32mint[m k[00;00m=[m[00;34m0[m[00;00m;[mk[00;00m<[ml[00;00m.[mw[00;00m*[ml[00;00m.[mh[00;00m*[ml[00;00m.[mn[00;00m;[mk[00;00m++)[m
        [00;00m{[m
            [00;34m// box b = boxes[k]; [m
            [00;32mconst int[m obj_id [00;00m=[m [00;32mmax_index[m[00;00m([mprobs[00;00m[[mk[00;00m],[m l[00;00m.[mclasses[00;00m);[m 
            [00;32mconst float[m prob [00;00m=[m probs[00;00m[[mk[00;00m][[mobj_id[00;00m];[m 
            [00;33mif[m[00;00m([mprob [00;00m>[m thresh[00;00m)[m
            [00;00m{[m
                [00;34m// bbox_t bbox;[m
                [00;34m// bbox.x = std::max((double)0, (b.x - b.w/2.)*imgs[j].w); [m
                [00;34m// bbox.y = std::max((double)0, (b.y - b.h/2.)*imgs[j].h); [m
                [00;34m// bbox.w = b.w*imgs[j].w; [m
                [00;34m// bbox.h = b.h*imgs[j].h;[m
                [00;34m// bbox.obj_id = obj_id;[m
                [00;34m// bbox.track_id = 0;  [m
                [00;34m// bbox.prob = prob; [m

                bbox_t bbox[00;00m;[m
                [00;33mif[m [00;00m([mboxes[00;00m[[mk[00;00m].[mw [00;00m>[m [00;34m1[m[00;00m) {[m
                    bbox[00;00m.[mx [00;00m=[m [00;34m0[m[00;00m;[m
                    bbox[00;00m.[mw [00;00m=[m img_ptrs[00;00m[[mj[00;00m]->[mw[00;00m;[m
                [00;00m}[m
                [00;33melse[m [00;00m{[m
                    [00;32mfloat[m w [00;00m=[m boxes[00;00m[[mk[00;00m].[mw [00;00m*[m img_ptrs[00;00m[[mj[00;00m]->[mw[00;00m;[m
                    bbox[00;00m.[mx [00;00m=[m [00;32mround[m[00;00m([mboxes[00;00m[[mk[00;00m].[mx [00;00m*[m img_ptrs[00;00m[[mj[00;00m]->[mw [00;00m-[m w [00;00m/[m [00;34m2[m[00;00m);[m
                    bbox[00;00m.[mw [00;00m=[m w[00;00m;[m
                [00;00m}[m
                [00;33mif[m [00;00m([mboxes[00;00m[[mk[00;00m].[mh [00;00m>[m [00;34m1[m[00;00m) {[m
                    bbox[00;00m.[my [00;00m=[m [00;34m0[m[00;00m;[m
                    bbox[00;00m.[mh [00;00m=[m img_ptrs[00;00m[[mj[00;00m]->[mh[00;00m;[m
                [00;00m}[m
                [00;33melse[m [00;00m{[m
                    [00;32mfloat[m h [00;00m=[m boxes[00;00m[[mk[00;00m].[mh [00;00m*[m img_ptrs[00;00m[[mj[00;00m]->[mh[00;00m;[m
                    bbox[00;00m.[my [00;00m=[m [00;32mround[m[00;00m([mboxes[00;00m[[mk[00;00m].[my [00;00m*[m img_ptrs[00;00m[[mj[00;00m]->[mh [00;00m-[m h [00;00m/[m [00;34m2[m[00;00m);[m
                    bbox[00;00m.[mh [00;00m=[m h[00;00m;[m
                [00;00m}[m
                bbox[00;00m.[mobj_id [00;00m=[m obj_id[00;00m;[m
                bbox[00;00m.[mtrack_id [00;00m=[m [00;34m0[m[00;00m;[m  
                bbox[00;00m.[mprob [00;00m=[m prob[00;00m;[m 

                bbox_vec[00;00m.[m[00;32mpush_back[m[00;00m([mbbox[00;00m);[m 
            [00;00m}[m
        [00;00m}[m
        bbox_vec_batch[00;00m.[m[00;32mpush_back[m[00;00m([mbbox_vec[00;00m);[m 

        l[00;00m.[moutput [00;00m+=[m l[00;00m.[mh[00;00m*[ml[00;00m.[mw[00;00m*[ml[00;00m.[mn[00;00m*([ml[00;00m.[mclasses [00;00m+[m l[00;00m.[mcoords [00;00m+[m [00;34m1[m[00;00m);[m [00;34m// stepping[m
        [00;34m// l.output = l.output + l.outputs; [m
        [00;32mfree[m[00;00m([mboxes[00;00m);[m 
        [00;32mfree_ptrs[m[00;00m(([m[00;32mvoid[m[00;00m**)[mprobs[00;00m,[m l[00;00m.[mw[00;00m*[ml[00;00m.[mh[00;00m*[ml[00;00m.[mn[00;00m);[m
    [00;00m}[m


    [00;32mfree[m[00;00m([mX[00;00m);[m 

    [00;33mif[m[00;00m([mm_currDeviceId [00;00m!=[m old_gpu_index[00;00m)[m [00;32mcuda_set_device[m[00;00m([mold_gpu_index[00;00m);[m 
    [00;33mreturn[m bbox_vec_batch[00;00m;[m
[00;00m}[m

BoxesVec [00;32mYOLO_Batch[m[00;00m::[m[00;32mdetect_resized_batch[m[00;00m([m
    ImagePtrList imgs_resized[00;00m,[m 
    [00;32mint[m init_w[00;00m,[m 
    [00;32mint[m init_h[00;00m,[m 
    [00;32mfloat[m thresh[00;00m)[m
[00;00m{[m
    BoxesVec bbox_vec_batch[00;00m;[m
    [00;33mif[m[00;00m([mm_detectType [00;00m==[m [00;34m1[m[00;00m)[m
        bbox_vec_batch [00;00m=[m [00;32mdetect_batch_yolo[m[00;00m([mimgs_resized[00;00m,[m thresh[00;00m);[m 
    [00;33melse[m bbox_vec_batch [00;00m=[m [00;32mdetect_batch_region[m[00;00m([mimgs_resized[00;00m,[m thresh[00;00m);[m 

    [00;32mfloat[m wk [00;00m= ([m[00;32mfloat[m[00;00m)[minit_w [00;00m/[m imgs_resized[00;00m[[m[00;34m0[m[00;00m]->[mw[00;00m;[m
    [00;32mfloat[m hk [00;00m= ([m[00;32mfloat[m[00;00m)[minit_h [00;00m/[m imgs_resized[00;00m[[m[00;34m0[m[00;00m]->[mh[00;00m;[m 
    [00;33mfor[m[00;00m([m[00;32mint[m i[00;00m=[m[00;34m0[m[00;00m;[mi[00;00m<[mm_batchsize[00;00m;[mi[00;00m++)[m
    [00;00m{[m
        [00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>&[m bbox_vec [00;00m=[m bbox_vec_batch[00;00m[[mi[00;00m];[m 
        [00;33mfor[m[00;00m([m[00;32mauto[m [00;00m&[mbbox[00;00m:[mbbox_vec[00;00m)[m
        [00;00m{[m
            bbox[00;00m.[mx [00;00m*=[m wk[00;00m;[m 
            bbox[00;00m.[mw [00;00m*=[m wk[00;00m;[m 
            bbox[00;00m.[my [00;00m*=[m hk[00;00m;[m 
            bbox[00;00m.[mh [00;00m*=[m hk[00;00m;[m 
        [00;00m}[m
    [00;00m}[m
    [00;33mreturn[m bbox_vec_batch[00;00m;[m 
[00;00m}[m

BoxesVec [00;32mYOLO_Batch[m[00;00m::[m[00;32mdetect_mat_batch[m[00;00m([m
    [00;32mstd[m[00;00m::[mvector[00;00m<[m[00;32mcv[m[00;00m::[mMat[00;00m>&[m mats[00;00m,[m 
    [00;32mfloat[m thresh[00;00m)[m
[00;00m{[m
    ImagePtrList img_ptrs[00;00m;[m 
    [00;33mfor[m[00;00m([m[00;32mint[m i[00;00m=[m[00;34m0[m[00;00m;[mi[00;00m<[mm_batchsize[00;00m;[mi[00;00m++)[m
    [00;00m{[m
        [00;32mauto[m image_ptr [00;00m=[m [00;32mmat_to_image_resize[m[00;00m([mmats[00;00m[[mi[00;00m]);[m 
        img_ptrs[00;00m.[m[00;32mpush_back[m[00;00m([mimage_ptr[00;00m);[m
    [00;00m}[m
    [00;33mreturn[m [00;32mdetect_resized_batch[m[00;00m([mimg_ptrs[00;00m,[m mats[00;00m[[m[00;34m0[m[00;00m].[mcols[00;00m,[m mats[00;00m[[m[00;34m0[m[00;00m].[mrows[00;00m,[m thresh [00;00m);[m 
[00;00m}[m


BoxesVec [00;32mYOLO_Batch[m[00;00m::[m[00;32mdetect_batch_yolo[m[00;00m([mImagePtrList img_ptrs[00;00m,[m [00;32mfloat[m thresh[00;00m)[m
[00;00m{[m
    detector_gpu_t[00;00m&[m detector_gpu [00;00m= *[m[00;33mstatic_cast[m[00;00m<[mdetector_gpu_t[00;00m*>([mm_detector_gpu_ptr[00;00m.[m[00;32mget[m[00;00m());[m
    network [00;00m&[mnet [00;00m=[m detector_gpu[00;00m.[mnet[00;00m;[m 
    [00;32mint[m old_gpu_index [00;00m=[m [00;32mcuda_get_device[m[00;00m();[m 
    [00;33mif[m[00;00m([mm_currDeviceId [00;00m>=[m[00;34m0[m [00;00m&&[m m_currDeviceId [00;00m!=[m old_gpu_index[00;00m)[m [00;32mcuda_set_device[m[00;00m([mnet[00;00m.[mgpu_index[00;00m);[m 
    net[00;00m.[mwait_stream [00;00m=[m m_waitStream[00;00m;[m 

    [00;34m// assume channel 3 [m

    [00;34m// std::cout << "debug: new X" << std::endl; [m
    [00;32mfloat[m [00;00m*[mX [00;00m= ([m[00;32mfloat[m[00;00m*)[m[00;32mcalloc[m[00;00m([mnet[00;00m.[mbatch[00;00m*[mnet[00;00m.[mw[00;00m*[mnet[00;00m.[mh[00;00m*[m[00;34m3[m[00;00m,[m[00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m));[m
    [00;33mfor[m[00;00m([m[00;32mint[m i[00;00m=[m[00;34m0[m[00;00m;[mi[00;00m<[mnet[00;00m.[mbatch[00;00m;[mi[00;00m++)[m
    [00;00m{[m
        image im[00;00m;[m 
        im[00;00m.[mc [00;00m=[m img_ptrs[00;00m[[mi[00;00m]->[mc[00;00m;[m
        im[00;00m.[mw [00;00m=[m img_ptrs[00;00m[[mi[00;00m]->[mw[00;00m;[m 
        im[00;00m.[mh [00;00m=[m img_ptrs[00;00m[[mi[00;00m]->[mh[00;00m;[m 
        im[00;00m.[mdata [00;00m=[m img_ptrs[00;00m[[mi[00;00m]->[mdata[00;00m;[m 
        image sized[00;00m;[m 
        [00;33mif[m[00;00m([mnet[00;00m.[mw[00;00m==[mim[00;00m.[mw [00;00m&&[m net[00;00m.[mh[00;00m==[mim[00;00m.[mh[00;00m)[m
        [00;00m{[m
            sized [00;00m=[m [00;32mmake_image[m[00;00m([mim[00;00m.[mw[00;00m,[mim[00;00m.[mh[00;00m,[mim[00;00m.[mc[00;00m);[m 
            [00;32mmemcpy[m[00;00m([msized[00;00m.[mdata[00;00m,[m im[00;00m.[mdata[00;00m,[m im[00;00m.[mw[00;00m*[mim[00;00m.[mh[00;00m*[mim[00;00m.[mc[00;00m*[m[00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m));[m 
        [00;00m}[m
        [00;33melse[m sized [00;00m=[m [00;32mresize_image[m[00;00m([mim[00;00m,[m net[00;00m.[mw[00;00m,[m net[00;00m.[mh[00;00m);[m 
        [00;32mmemcpy[m[00;00m([mX[00;00m+[mi[00;00m*[mnet[00;00m.[mh[00;00m*[mnet[00;00m.[mw[00;00m*[m[00;34m3[m[00;00m,[m sized[00;00m.[mdata[00;00m,[m net[00;00m.[mh[00;00m*[mnet[00;00m.[mw[00;00m*[m[00;34m3[m[00;00m*[m[00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m));[m 

        [00;32mfree[m[00;00m([msized[00;00m.[mdata[00;00m);[m 
    [00;00m}[m 
    [00;34m// std::cout << "debug: predict  "  << std::endl; [m
    [00;34m// predict [m
    [00;32mnetwork_predict[m[00;00m([mnet[00;00m,[m X[00;00m);[m 
    layer l [00;00m=[m net[00;00m.[mlayers[00;00m[[mnet[00;00m.[mn[00;00m-[m[00;34m1[m[00;00m];[m 
   [00;34m// get bbox[m
    BoxesVec bbox_vec_batch[00;00m;[m 

    [00;33mfor[m[00;00m([m[00;32mint[m j[00;00m=[m[00;34m0[m[00;00m;[mj[00;00m<[mnet[00;00m.[mbatch[00;00m;[mj[00;00m++)[m
    [00;00m{[m
        [00;34m// std::cout << "get box " << j << std::endl; [m
        [00;32mint[m nboxes [00;00m=[m [00;34m0[m[00;00m;[m 
        [00;32mint[m letterbox [00;00m=[m [00;34m0[m[00;00m;[m 
        [00;32mfloat[m hier_thresh [00;00m=[m [00;34m0.5[m[00;00m;[m 
        detection[00;00m*[m dets [00;00m=[m [00;32mget_network_boxes[m[00;00m(&[mnet[00;00m,[mimg_ptrs[00;00m[[mj[00;00m]->[mw[00;00m,[mimg_ptrs[00;00m[[mj[00;00m]->[mh[00;00m,[m
                                             thresh[00;00m,[m hier_thresh[00;00m,[m
                                             [00;34m0[m[00;00m,[m[00;34m1[m[00;00m,&[mnboxes[00;00m,[m letterbox[00;00m);[m
        [00;32mdo_nms_sort[m[00;00m([mdets[00;00m,[m nboxes[00;00m,[m l[00;00m.[mclasses[00;00m,[mm_nms[00;00m);[m 

        [00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m bbox_vec[00;00m;[m 
        [00;33mfor[m[00;00m([m[00;32mint[m i[00;00m=[m[00;34m0[m[00;00m;[mi[00;00m<[mnboxes[00;00m;++[mi[00;00m)[m
        [00;00m{[m
            box b [00;00m=[m dets[00;00m[[mi[00;00m].[mbbox[00;00m;[m  
            [00;32mconst int[m obj_id [00;00m=[m [00;32mmax_index[m[00;00m([mdets[00;00m[[mi[00;00m].[mprob[00;00m,[m l[00;00m.[mclasses[00;00m);[m 
            [00;32mconst float[m prob [00;00m=[m dets[00;00m[[mi[00;00m].[mprob[00;00m[[mobj_id[00;00m];[m
            [00;33mif[m[00;00m([mprob[00;00m>[mthresh[00;00m)[m
            [00;00m{[m
                bbox_t bbox[00;00m;[m 
                bbox[00;00m.[mx [00;00m=[m [00;32mstd[m[00;00m::[m[00;32mmax[m[00;00m(([m[00;32mdouble[m[00;00m)[m[00;34m0[m[00;00m,([mb[00;00m.[mx[00;00m-[mb[00;00m.[mw[00;00m/[m[00;34m2[m[00;00m.)*[mimg_ptrs[00;00m[[mj[00;00m]->[mw[00;00m);[m
                bbox[00;00m.[my [00;00m=[m [00;32mstd[m[00;00m::[m[00;32mmax[m[00;00m(([m[00;32mdouble[m[00;00m)[m[00;34m0[m[00;00m,([mb[00;00m.[my[00;00m-[mb[00;00m.[mh[00;00m/[m[00;34m2[m[00;00m.)*[mimg_ptrs[00;00m[[mj[00;00m]->[mh[00;00m);[m
                bbox[00;00m.[mw [00;00m=[m b[00;00m.[mw[00;00m*[mimg_ptrs[00;00m[[mj[00;00m]->[mw[00;00m;[m
                bbox[00;00m.[mh [00;00m=[m b[00;00m.[mh[00;00m*[mimg_ptrs[00;00m[[mj[00;00m]->[mh[00;00m;[m 
                bbox[00;00m.[mobj_id [00;00m=[m obj_id[00;00m;[m
                bbox[00;00m.[mprob [00;00m=[m prob[00;00m;[m
                bbox[00;00m.[mtrack_id [00;00m=[m [00;34m0[m[00;00m;[m

                bbox_vec[00;00m.[m[00;32mpush_back[m[00;00m([mbbox[00;00m);[m
            [00;00m}[m
        [00;00m}[m

        [00;34m// std::cout << "debug: free detection " << std::endl; [m
        bbox_vec_batch[00;00m.[m[00;32mpush_back[m[00;00m([mbbox_vec[00;00m);[m 
        [00;32mfree_detections[m[00;00m([mdets[00;00m,[m nboxes[00;00m);[m 
        [00;34m// stepping [m
        [00;34m// std::cout << "debug: stepping" << std::endl; [m
        [00;33mfor[m[00;00m([m[00;32mint[m j[00;00m=[m[00;34m0[m[00;00m;[mj[00;00m<[mnet[00;00m.[mn[00;00m;[mj[00;00m++)[m
        [00;00m{[m
            layer[00;00m&[m temp_l [00;00m=[m net[00;00m.[mlayers[00;00m[[mj[00;00m];[m
            [00;33mif[m[00;00m([mtemp_l[00;00m.[mtype[00;00m==[mYOLO [00;00m||[m temp_l[00;00m.[mtype[00;00m==[mREGION [00;00m||[m temp_l[00;00m.[mtype[00;00m==[mDETECTION[00;00m)[m
            [00;00m{[m
                temp_l[00;00m.[moutput [00;00m=[m temp_l[00;00m.[moutput [00;00m+[m temp_l[00;00m.[moutputs[00;00m;[m 
            [00;00m}[m
        [00;00m}[m
    [00;00m}[m
    [00;33mfor[m[00;00m([m[00;32mint[m j[00;00m=[m[00;34m0[m[00;00m;[mj[00;00m<[mnet[00;00m.[mn[00;00m;[mj[00;00m++)[m
    [00;00m{[m
        layer[00;00m&[m temp_l [00;00m=[m net[00;00m.[mlayers[00;00m[[mj[00;00m];[m
        [00;33mif[m[00;00m([mtemp_l[00;00m.[mtype[00;00m==[mYOLO [00;00m||[m temp_l[00;00m.[mtype[00;00m==[mREGION [00;00m||[m temp_l[00;00m.[mtype[00;00m==[mDETECTION[00;00m)[m
        [00;00m{[m
            [00;33mfor[m[00;00m([m[00;32mint[m i[00;00m=[m[00;34m0[m[00;00m;[mi[00;00m<[mnet[00;00m.[mbatch[00;00m;[mi[00;00m++)[m
            temp_l[00;00m.[moutput [00;00m=[m temp_l[00;00m.[moutput [00;00m-[m temp_l[00;00m.[moutputs[00;00m;[m 
        [00;00m}[m
    [00;00m}[m
    [00;34m// std::cout << "debug: free x " << std::endl; [m
    [00;33mif[m[00;00m([mX[00;00m)[m
    [00;32mfree[m[00;00m([mX[00;00m);[m 

    [00;33mif[m[00;00m([mm_currDeviceId [00;00m!=[m old_gpu_index[00;00m)[m [00;32mcuda_set_device[m[00;00m([mold_gpu_index[00;00m);[m 

    [00;33mreturn[m bbox_vec_batch[00;00m;[m
[00;00m}[m
