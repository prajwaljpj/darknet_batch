[00;35m#include[m [00;31m"darknet.h"[m[00;35m[m
[00;35m#include[m [00;31m"yolo_v2_class.hpp"[m[00;35m[m

[00;35m#include[m [00;31m"network.h"[m[00;35m[m

[00;32mextern[m [00;31m"C"[m [00;00m{[m
[00;35m#include[m [00;31m"detection_layer.h"[m[00;35m[m
[00;35m#include[m [00;31m"region_layer.h"[m[00;35m[m
[00;35m#include[m [00;31m"cost_layer.h"[m[00;35m[m
[00;35m#include[m [00;31m"utils.h"[m[00;35m[m
[00;35m#include[m [00;31m"parser.h"[m[00;35m[m
[00;35m#include[m [00;31m"box.h"[m[00;35m[m
[00;35m#include[m [00;31m"image.h"[m[00;35m[m
[00;35m#include[m [00;31m"demo.h"[m[00;35m[m
[00;35m#include[m [00;31m"option_list.h"[m[00;35m[m
[00;35m#include[m [00;31m"stb_image.h"[m[00;35m[m
[00;00m}[m
[00;34m//#include <sys/time.h>[m

[00;35m#include <vector>[m
[00;35m#include <iostream>[m
[00;35m#include <algorithm>[m
[00;35m#include <cmath>[m


[00;34m//static Detector* detector = NULL;[m
[00;32mstatic[m [00;32mstd[m[00;00m::[munique_ptr[00;00m<[mDetector[00;00m>[m detector[00;00m;[m

[00;32mint[m [00;32minit[m[00;00m([m[00;32mconst char[m [00;00m*[mconfigurationFilename[00;00m,[m [00;32mconst char[m [00;00m*[mweightsFilename[00;00m,[m [00;32mint[m gpu[00;00m)[m
[00;00m{[m
    detector[00;00m.[m[00;32mreset[m[00;00m([m[00;33mnew[m [00;32mDetector[m[00;00m([mconfigurationFilename[00;00m,[m weightsFilename[00;00m,[m gpu[00;00m));[m
    [00;33mreturn[m [00;34m1[m[00;00m;[m
[00;00m}[m

[00;32mint[m [00;32mdetect_image[m[00;00m([m[00;32mconst char[m [00;00m*[mfilename[00;00m,[m bbox_t_container [00;00m&[mcontainer[00;00m)[m
[00;00m{[m
    [00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m detection [00;00m=[m detector[00;00m->[m[00;32mdetect[m[00;00m([mfilename[00;00m);[m
    [00;33mfor[m [00;00m([m[00;32msize_t[m i [00;00m=[m [00;34m0[m[00;00m;[m i [00;00m<[m detection[00;00m.[m[00;32msize[m[00;00m() &&[m i [00;00m<[m C_SHARP_MAX_OBJECTS[00;00m; ++[mi[00;00m)[m
        container[00;00m.[mcandidates[00;00m[[mi[00;00m] =[m detection[00;00m[[mi[00;00m];[m
    [00;33mreturn[m detection[00;00m.[m[00;32msize[m[00;00m();[m
[00;00m}[m

[00;32mint[m [00;32mdetect_mat[m[00;00m([m[00;32mconst uint8_t[m[00;00m*[m data[00;00m,[m [00;32mconst size_t[m data_length[00;00m,[m bbox_t_container [00;00m&[mcontainer[00;00m) {[m
[00;35m#ifdef OPENCV[m
    [00;32mstd[m[00;00m::[mvector[00;00m<[m[00;32mchar[m[00;00m>[m [00;32mvdata[m[00;00m([mdata[00;00m,[m data [00;00m+[m data_length[00;00m);[m
    [00;32mcv[m[00;00m::[mMat image [00;00m=[m [00;32mimdecode[m[00;00m([m[00;32mcv[m[00;00m::[m[00;32mMat[m[00;00m([mvdata[00;00m),[m [00;34m1[m[00;00m);[m

    [00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m detection [00;00m=[m detector[00;00m->[m[00;32mdetect[m[00;00m([mimage[00;00m);[m
    [00;33mfor[m [00;00m([m[00;32msize_t[m i [00;00m=[m [00;34m0[m[00;00m;[m i [00;00m<[m detection[00;00m.[m[00;32msize[m[00;00m() &&[m i [00;00m<[m C_SHARP_MAX_OBJECTS[00;00m; ++[mi[00;00m)[m
        container[00;00m.[mcandidates[00;00m[[mi[00;00m] =[m detection[00;00m[[mi[00;00m];[m
    [00;33mreturn[m detection[00;00m.[m[00;32msize[m[00;00m();[m
[00;35m#else[m
    [00;33mreturn[m [00;00m-[m[00;34m1[m[00;00m;[m
[00;35m#endif[m    [00;34m// OPENCV[m
[00;35m[m[00;00m}[m

[00;32mint[m [00;32mdispose[m[00;00m() {[m
    [00;34m//if (detector != NULL) delete detector;[m
    [00;34m//detector = NULL;[m
    detector[00;00m.[m[00;32mreset[m[00;00m();[m
    [00;33mreturn[m [00;34m1[m[00;00m;[m
[00;00m}[m

[00;32mint[m [00;32mget_device_count[m[00;00m() {[m
[00;35m#ifdef GPU[m
    [00;32mint[m count [00;00m=[m [00;34m0[m[00;00m;[m
    [00;32mcudaGetDeviceCount[m[00;00m(&[mcount[00;00m);[m
    [00;33mreturn[m count[00;00m;[m
[00;35m#else[m
    [00;33mreturn[m [00;00m-[m[00;34m1[m[00;00m;[m
[00;35m#endif[m	[00;34m// GPU[m
[00;35m[m[00;00m}[m

[00;32mint[m [00;32mget_device_name[m[00;00m([m[00;32mint[m gpu[00;00m,[m [00;32mchar[m[00;00m*[m deviceName[00;00m) {[m
[00;35m#ifdef GPU[m
    cudaDeviceProp prop[00;00m;[m
    [00;32mcudaGetDeviceProperties[m[00;00m(&[mprop[00;00m,[m gpu[00;00m);[m
    [00;32mstd[m[00;00m::[mstring result [00;00m=[m prop[00;00m.[mname[00;00m;[m
    [00;32mstd[m[00;00m::[m[00;32mcopy[m[00;00m([mresult[00;00m.[m[00;32mbegin[m[00;00m(),[m result[00;00m.[m[00;32mend[m[00;00m(),[m deviceName[00;00m);[m
    [00;33mreturn[m [00;34m1[m[00;00m;[m
[00;35m#else[m
    [00;33mreturn[m [00;00m-[m[00;34m1[m[00;00m;[m
[00;35m#endif[m	[00;34m// GPU[m
[00;35m[m[00;00m}[m

[00;35m#ifdef GPU[m
[00;32mvoid[m [00;32mcheck_cuda[m[00;00m([mcudaError_t status[00;00m) {[m
    [00;33mif[m [00;00m([mstatus [00;00m!=[m cudaSuccess[00;00m) {[m
        [00;32mconst char[m [00;00m*[ms [00;00m=[m [00;32mcudaGetErrorString[m[00;00m([mstatus[00;00m);[m
        [00;32mprintf[m[00;00m([m[00;31m"CUDA Error Prev: %s[m[00;35m\n[m[00;31m"[m[00;00m,[m s[00;00m);[m
    [00;00m}[m
[00;00m}[m
[00;35m#endif[m

[00;32mstruct[m detector_gpu_t [00;00m{[m
    network net[00;00m;[m
    image images[00;00m[[mNFRAMES[00;00m];[m
    [00;32mfloat[m [00;00m*[mavg[00;00m;[m
    [00;32mfloat[m[00;00m*[m predictions[00;00m[[mNFRAMES[00;00m];[m
    [00;32mint[m demo_index[00;00m;[m
    [00;32munsigned int[m [00;00m*[mtrack_id[00;00m;[m
[00;00m};[m

LIB_API [00;32mDetector[m[00;00m::[m[00;32mDetector[m[00;00m([m[00;32mstd[m[00;00m::[mstring cfg_filename[00;00m,[m [00;32mstd[m[00;00m::[mstring weight_filename[00;00m,[m [00;32mint[m gpu_id[00;00m) :[m [00;32mcur_gpu_id[m[00;00m([mgpu_id[00;00m)[m
[00;00m{[m
    wait_stream [00;00m=[m [00;34m0[m[00;00m;[m
[00;35m#ifdef GPU[m
    [00;32mint[m old_gpu_index[00;00m;[m
    [00;32mcheck_cuda[m[00;00m([m [00;32mcudaGetDevice[m[00;00m(&[mold_gpu_index[00;00m) );[m
[00;35m#endif[m

    detector_gpu_ptr [00;00m=[m [00;32mstd[m[00;00m::[mmake_shared[00;00m<[mdetector_gpu_t[00;00m>();[m
    detector_gpu_t [00;00m&[mdetector_gpu [00;00m= *[m[00;33mstatic_cast[m[00;00m<[mdetector_gpu_t [00;00m*>([mdetector_gpu_ptr[00;00m.[m[00;32mget[m[00;00m());[m

[00;35m#ifdef GPU[m
    [00;34m//check_cuda( cudaSetDevice(cur_gpu_id) );[m
    [00;32mcuda_set_device[m[00;00m([mcur_gpu_id[00;00m);[m
    [00;32mprintf[m[00;00m([m[00;31m" Used GPU %d[m [00;35m\n[m[00;31m"[m[00;00m,[m cur_gpu_id[00;00m);[m
[00;35m#endif[m
    network [00;00m&[mnet [00;00m=[m detector_gpu[00;00m.[mnet[00;00m;[m
    net[00;00m.[mgpu_index [00;00m=[m cur_gpu_id[00;00m;[m
    [00;34m//gpu_index = i;[m

    [00;32mchar[m [00;00m*[mcfgfile [00;00m=[m [00;33mconst_cast[m[00;00m<[m[00;32mchar[m [00;00m*>([mcfg_filename[00;00m.[m[00;32mdata[m[00;00m());[m
    [00;32mchar[m [00;00m*[mweightfile [00;00m=[m [00;33mconst_cast[m[00;00m<[m[00;32mchar[m [00;00m*>([mweight_filename[00;00m.[m[00;32mdata[m[00;00m());[m

    net [00;00m=[m [00;32mparse_network_cfg_custom[m[00;00m([mcfgfile[00;00m,[m [00;34m1[m[00;00m,[m [00;34m0[m[00;00m);[m
    [00;33mif[m [00;00m([mweightfile[00;00m) {[m
        [00;32mload_weights[m[00;00m(&[mnet[00;00m,[m weightfile[00;00m);[m
    [00;00m}[m
    [00;32mset_batch_network[m[00;00m(&[mnet[00;00m,[m [00;34m1[m[00;00m);[m
    net[00;00m.[mgpu_index [00;00m=[m cur_gpu_id[00;00m;[m
    [00;32mfuse_conv_batchnorm[m[00;00m([mnet[00;00m);[m

    layer l [00;00m=[m net[00;00m.[mlayers[00;00m[[mnet[00;00m.[mn [00;00m-[m [00;34m1[m[00;00m];[m
    [00;32mint[m j[00;00m;[m

    detector_gpu[00;00m.[mavg [00;00m= ([m[00;32mfloat[m [00;00m*)[m[00;32mcalloc[m[00;00m([ml[00;00m.[moutputs[00;00m,[m [00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m));[m
    [00;33mfor[m [00;00m([mj [00;00m=[m [00;34m0[m[00;00m;[m j [00;00m<[m NFRAMES[00;00m; ++[mj[00;00m)[m detector_gpu[00;00m.[mpredictions[00;00m[[mj[00;00m] = ([m[00;32mfloat[m[00;00m*)[m[00;32mcalloc[m[00;00m([ml[00;00m.[moutputs[00;00m,[m [00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m));[m
    [00;33mfor[m [00;00m([mj [00;00m=[m [00;34m0[m[00;00m;[m j [00;00m<[m NFRAMES[00;00m; ++[mj[00;00m)[m detector_gpu[00;00m.[mimages[00;00m[[mj[00;00m] =[m [00;32mmake_image[m[00;00m([m[00;34m1[m[00;00m,[m [00;34m1[m[00;00m,[m [00;34m3[m[00;00m);[m

    detector_gpu[00;00m.[mtrack_id [00;00m= ([m[00;32munsigned int[m [00;00m*)[m[00;32mcalloc[m[00;00m([ml[00;00m.[mclasses[00;00m,[m [00;33msizeof[m[00;00m([m[00;32munsigned int[m[00;00m));[m
    [00;33mfor[m [00;00m([mj [00;00m=[m [00;34m0[m[00;00m;[m j [00;00m<[m l[00;00m.[mclasses[00;00m; ++[mj[00;00m)[m detector_gpu[00;00m.[mtrack_id[00;00m[[mj[00;00m] =[m [00;34m1[m[00;00m;[m

[00;35m#ifdef GPU[m
    [00;32mcheck_cuda[m[00;00m([m [00;32mcudaSetDevice[m[00;00m([mold_gpu_index[00;00m) );[m
[00;35m#endif[m
[00;00m}[m


LIB_API [00;32mDetector[m[00;00m::~[m[00;32mDetector[m[00;00m()[m
[00;00m{[m
    detector_gpu_t [00;00m&[mdetector_gpu [00;00m= *[m[00;33mstatic_cast[m[00;00m<[mdetector_gpu_t [00;00m*>([mdetector_gpu_ptr[00;00m.[m[00;32mget[m[00;00m());[m
    [00;34m//layer l = detector_gpu.net.layers[detector_gpu.net.n - 1];[m

    [00;32mfree[m[00;00m([mdetector_gpu[00;00m.[mtrack_id[00;00m);[m

    [00;32mfree[m[00;00m([mdetector_gpu[00;00m.[mavg[00;00m);[m
    [00;33mfor[m [00;00m([m[00;32mint[m j [00;00m=[m [00;34m0[m[00;00m;[m j [00;00m<[m NFRAMES[00;00m; ++[mj[00;00m)[m [00;32mfree[m[00;00m([mdetector_gpu[00;00m.[mpredictions[00;00m[[mj[00;00m]);[m
    [00;33mfor[m [00;00m([m[00;32mint[m j [00;00m=[m [00;34m0[m[00;00m;[m j [00;00m<[m NFRAMES[00;00m; ++[mj[00;00m)[m [00;33mif[m [00;00m([mdetector_gpu[00;00m.[mimages[00;00m[[mj[00;00m].[mdata[00;00m)[m [00;32mfree[m[00;00m([mdetector_gpu[00;00m.[mimages[00;00m[[mj[00;00m].[mdata[00;00m);[m

[00;35m#ifdef GPU[m
    [00;32mint[m old_gpu_index[00;00m;[m
    [00;32mcudaGetDevice[m[00;00m(&[mold_gpu_index[00;00m);[m
    [00;32mcuda_set_device[m[00;00m([mdetector_gpu[00;00m.[mnet[00;00m.[mgpu_index[00;00m);[m
[00;35m#endif[m

    [00;32mfree_network[m[00;00m([mdetector_gpu[00;00m.[mnet[00;00m);[m

[00;35m#ifdef GPU[m
    [00;32mcudaSetDevice[m[00;00m([mold_gpu_index[00;00m);[m
[00;35m#endif[m
[00;00m}[m

LIB_API [00;32mint[m [00;32mDetector[m[00;00m::[m[00;32mget_net_width[m[00;00m()[m [00;32mconst[m [00;00m{[m
    detector_gpu_t [00;00m&[mdetector_gpu [00;00m= *[m[00;33mstatic_cast[m[00;00m<[mdetector_gpu_t [00;00m*>([mdetector_gpu_ptr[00;00m.[m[00;32mget[m[00;00m());[m
    [00;33mreturn[m detector_gpu[00;00m.[mnet[00;00m.[mw[00;00m;[m
[00;00m}[m
LIB_API [00;32mint[m [00;32mDetector[m[00;00m::[m[00;32mget_net_height[m[00;00m()[m [00;32mconst[m [00;00m{[m
    detector_gpu_t [00;00m&[mdetector_gpu [00;00m= *[m[00;33mstatic_cast[m[00;00m<[mdetector_gpu_t [00;00m*>([mdetector_gpu_ptr[00;00m.[m[00;32mget[m[00;00m());[m
    [00;33mreturn[m detector_gpu[00;00m.[mnet[00;00m.[mh[00;00m;[m
[00;00m}[m
LIB_API [00;32mint[m [00;32mDetector[m[00;00m::[m[00;32mget_net_color_depth[m[00;00m()[m [00;32mconst[m [00;00m{[m
    detector_gpu_t [00;00m&[mdetector_gpu [00;00m= *[m[00;33mstatic_cast[m[00;00m<[mdetector_gpu_t [00;00m*>([mdetector_gpu_ptr[00;00m.[m[00;32mget[m[00;00m());[m
    [00;33mreturn[m detector_gpu[00;00m.[mnet[00;00m.[mc[00;00m;[m
[00;00m}[m


LIB_API [00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m [00;32mDetector[m[00;00m::[m[00;32mdetect[m[00;00m([m[00;32mstd[m[00;00m::[mstring image_filename[00;00m,[m [00;32mfloat[m thresh[00;00m,[m [00;32mbool[m use_mean[00;00m)[m
[00;00m{[m
    [00;32mstd[m[00;00m::[mshared_ptr[00;00m<[mimage_t[00;00m>[m [00;32mimage_ptr[m[00;00m([m[00;33mnew[m image_t[00;00m, []([mimage_t [00;00m*[mimg[00;00m) {[m [00;33mif[m [00;00m([mimg[00;00m->[mdata[00;00m)[m [00;32mfree[m[00;00m([mimg[00;00m->[mdata[00;00m);[m [00;33mdelete[m img[00;00m; });[m
    [00;00m*[mimage_ptr [00;00m=[m [00;32mload_image[m[00;00m([mimage_filename[00;00m);[m
    [00;33mreturn[m [00;32mdetect[m[00;00m(*[mimage_ptr[00;00m,[m thresh[00;00m,[m use_mean[00;00m);[m
[00;00m}[m

[00;32mstatic[m image [00;32mload_image_stb[m[00;00m([m[00;32mchar[m [00;00m*[mfilename[00;00m,[m [00;32mint[m channels[00;00m)[m
[00;00m{[m
    [00;32mint[m w[00;00m,[m h[00;00m,[m c[00;00m;[m
    [00;32munsigned char[m [00;00m*[mdata [00;00m=[m [00;32mstbi_load[m[00;00m([mfilename[00;00m, &[mw[00;00m, &[mh[00;00m, &[mc[00;00m,[m channels[00;00m);[m
    [00;33mif[m [00;00m(![mdata[00;00m)[m
        [00;33mthrow[m [00;32mstd[m[00;00m::[m[00;32mruntime_error[m[00;00m([m[00;31m"file not found"[m[00;00m);[m
    [00;33mif[m [00;00m([mchannels[00;00m)[m c [00;00m=[m channels[00;00m;[m
    [00;32mint[m i[00;00m,[m j[00;00m,[m k[00;00m;[m
    image im [00;00m=[m [00;32mmake_image[m[00;00m([mw[00;00m,[m h[00;00m,[m c[00;00m);[m
    [00;33mfor[m [00;00m([mk [00;00m=[m [00;34m0[m[00;00m;[m k [00;00m<[m c[00;00m; ++[mk[00;00m) {[m
        [00;33mfor[m [00;00m([mj [00;00m=[m [00;34m0[m[00;00m;[m j [00;00m<[m h[00;00m; ++[mj[00;00m) {[m
            [00;33mfor[m [00;00m([mi [00;00m=[m [00;34m0[m[00;00m;[m i [00;00m<[m w[00;00m; ++[mi[00;00m) {[m
                [00;32mint[m dst_index [00;00m=[m i [00;00m+[m w[00;00m*[mj [00;00m+[m w[00;00m*[mh[00;00m*[mk[00;00m;[m
                [00;32mint[m src_index [00;00m=[m k [00;00m+[m c[00;00m*[mi [00;00m+[m c[00;00m*[mw[00;00m*[mj[00;00m;[m
                im[00;00m.[mdata[00;00m[[mdst_index[00;00m] = ([m[00;32mfloat[m[00;00m)[mdata[00;00m[[msrc_index[00;00m] /[m [00;34m255[m[00;00m.;[m
            [00;00m}[m
        [00;00m}[m
    [00;00m}[m
    [00;32mfree[m[00;00m([mdata[00;00m);[m
    [00;33mreturn[m im[00;00m;[m
[00;00m}[m

LIB_API image_t [00;32mDetector[m[00;00m::[m[00;32mload_image[m[00;00m([m[00;32mstd[m[00;00m::[mstring image_filename[00;00m)[m
[00;00m{[m
    [00;32mchar[m [00;00m*[minput [00;00m=[m [00;33mconst_cast[m[00;00m<[m[00;32mchar[m [00;00m*>([mimage_filename[00;00m.[m[00;32mdata[m[00;00m());[m
    image im [00;00m=[m [00;32mload_image_stb[m[00;00m([minput[00;00m,[m [00;34m3[m[00;00m);[m

    image_t img[00;00m;[m
    img[00;00m.[mc [00;00m=[m im[00;00m.[mc[00;00m;[m
    img[00;00m.[mdata [00;00m=[m im[00;00m.[mdata[00;00m;[m
    img[00;00m.[mh [00;00m=[m im[00;00m.[mh[00;00m;[m
    img[00;00m.[mw [00;00m=[m im[00;00m.[mw[00;00m;[m

    [00;33mreturn[m img[00;00m;[m
[00;00m}[m


LIB_API [00;32mvoid[m [00;32mDetector[m[00;00m::[m[00;32mfree_image[m[00;00m([mimage_t m[00;00m)[m
[00;00m{[m
    [00;33mif[m [00;00m([mm[00;00m.[mdata[00;00m) {[m
        [00;32mfree[m[00;00m([mm[00;00m.[mdata[00;00m);[m
    [00;00m}[m
[00;00m}[m

LIB_API [00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m [00;32mDetector[m[00;00m::[m[00;32mdetect[m[00;00m([mimage_t img[00;00m,[m [00;32mfloat[m thresh[00;00m,[m [00;32mbool[m use_mean[00;00m)[m
[00;00m{[m
    detector_gpu_t [00;00m&[mdetector_gpu [00;00m= *[m[00;33mstatic_cast[m[00;00m<[mdetector_gpu_t [00;00m*>([mdetector_gpu_ptr[00;00m.[m[00;32mget[m[00;00m());[m
    network [00;00m&[mnet [00;00m=[m detector_gpu[00;00m.[mnet[00;00m;[m
[00;35m#ifdef GPU[m
    [00;32mint[m old_gpu_index[00;00m;[m
    [00;32mcudaGetDevice[m[00;00m(&[mold_gpu_index[00;00m);[m
    [00;33mif[m[00;00m([mcur_gpu_id [00;00m!=[m old_gpu_index[00;00m)[m
        [00;32mcudaSetDevice[m[00;00m([mnet[00;00m.[mgpu_index[00;00m);[m

    net[00;00m.[mwait_stream [00;00m=[m wait_stream[00;00m;[m    [00;34m// 1 - wait CUDA-stream, 0 - not to wait[m
[00;35m#endif[m
    [00;34m//std::cout << "net.gpu_index = " << net.gpu_index << std::endl;[m

    image im[00;00m;[m
    im[00;00m.[mc [00;00m=[m img[00;00m.[mc[00;00m;[m
    im[00;00m.[mdata [00;00m=[m img[00;00m.[mdata[00;00m;[m
    im[00;00m.[mh [00;00m=[m img[00;00m.[mh[00;00m;[m
    im[00;00m.[mw [00;00m=[m img[00;00m.[mw[00;00m;[m

    image sized[00;00m;[m

    [00;33mif[m [00;00m([mnet[00;00m.[mw [00;00m==[m im[00;00m.[mw [00;00m&&[m net[00;00m.[mh [00;00m==[m im[00;00m.[mh[00;00m) {[m
        sized [00;00m=[m [00;32mmake_image[m[00;00m([mim[00;00m.[mw[00;00m,[m im[00;00m.[mh[00;00m,[m im[00;00m.[mc[00;00m);[m
        [00;32mmemcpy[m[00;00m([msized[00;00m.[mdata[00;00m,[m im[00;00m.[mdata[00;00m,[m im[00;00m.[mw[00;00m*[mim[00;00m.[mh[00;00m*[mim[00;00m.[mc [00;00m*[m [00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m));[m
    [00;00m}[m
    [00;33melse[m
        sized [00;00m=[m [00;32mresize_image[m[00;00m([mim[00;00m,[m net[00;00m.[mw[00;00m,[m net[00;00m.[mh[00;00m);[m

    layer l [00;00m=[m net[00;00m.[mlayers[00;00m[[mnet[00;00m.[mn [00;00m-[m [00;34m1[m[00;00m];[m

    [00;32mfloat[m [00;00m*[mX [00;00m=[m sized[00;00m.[mdata[00;00m;[m

    [00;32mfloat[m [00;00m*[mprediction [00;00m=[m [00;32mnetwork_predict[m[00;00m([mnet[00;00m,[m X[00;00m);[m

    [00;33mif[m [00;00m([muse_mean[00;00m) {[m
        [00;32mmemcpy[m[00;00m([mdetector_gpu[00;00m.[mpredictions[00;00m[[mdetector_gpu[00;00m.[mdemo_index[00;00m],[m prediction[00;00m,[m l[00;00m.[moutputs [00;00m*[m [00;33msizeof[m[00;00m([m[00;32mfloat[m[00;00m));[m
        [00;32mmean_arrays[m[00;00m([mdetector_gpu[00;00m.[mpredictions[00;00m,[m NFRAMES[00;00m,[m l[00;00m.[moutputs[00;00m,[m detector_gpu[00;00m.[mavg[00;00m);[m
        l[00;00m.[moutput [00;00m=[m detector_gpu[00;00m.[mavg[00;00m;[m
        detector_gpu[00;00m.[mdemo_index [00;00m= ([mdetector_gpu[00;00m.[mdemo_index [00;00m+[m [00;34m1[m[00;00m) %[m NFRAMES[00;00m;[m
    [00;00m}[m
    [00;34m//get_region_boxes(l, 1, 1, thresh, detector_gpu.probs, detector_gpu.boxes, 0, 0);[m
    [00;34m//if (nms) do_nms_sort(detector_gpu.boxes, detector_gpu.probs, l.w*l.h*l.n, l.classes, nms);[m

    [00;32mint[m nboxes [00;00m=[m [00;34m0[m[00;00m;[m
    [00;32mint[m letterbox [00;00m=[m [00;34m0[m[00;00m;[m
    [00;32mfloat[m hier_thresh [00;00m=[m [00;34m0.5[m[00;00m;[m
    detection [00;00m*[mdets [00;00m=[m [00;32mget_network_boxes[m[00;00m(&[mnet[00;00m,[m im[00;00m.[mw[00;00m,[m im[00;00m.[mh[00;00m,[m thresh[00;00m,[m hier_thresh[00;00m,[m [00;34m0[m[00;00m,[m [00;34m1[m[00;00m, &[mnboxes[00;00m,[m letterbox[00;00m);[m
    [00;33mif[m [00;00m([mnms[00;00m)[m [00;32mdo_nms_sort[m[00;00m([mdets[00;00m,[m nboxes[00;00m,[m l[00;00m.[mclasses[00;00m,[m nms[00;00m);[m

    [00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m bbox_vec[00;00m;[m

    [00;33mfor[m [00;00m([m[00;32mint[m i [00;00m=[m [00;34m0[m[00;00m;[m i [00;00m<[m nboxes[00;00m; ++[mi[00;00m) {[m
        box b [00;00m=[m dets[00;00m[[mi[00;00m].[mbbox[00;00m;[m
        [00;32mint const[m obj_id [00;00m=[m [00;32mmax_index[m[00;00m([mdets[00;00m[[mi[00;00m].[mprob[00;00m,[m l[00;00m.[mclasses[00;00m);[m
        [00;32mfloat const[m prob [00;00m=[m dets[00;00m[[mi[00;00m].[mprob[00;00m[[mobj_id[00;00m];[m

        [00;33mif[m [00;00m([mprob [00;00m>[m thresh[00;00m)[m
        [00;00m{[m
            bbox_t bbox[00;00m;[m
            bbox[00;00m.[mx [00;00m=[m [00;32mstd[m[00;00m::[m[00;32mmax[m[00;00m(([m[00;32mdouble[m[00;00m)[m[00;34m0[m[00;00m, ([mb[00;00m.[mx [00;00m-[m b[00;00m.[mw [00;00m/[m [00;34m2[m[00;00m.)*[mim[00;00m.[mw[00;00m);[m
            bbox[00;00m.[my [00;00m=[m [00;32mstd[m[00;00m::[m[00;32mmax[m[00;00m(([m[00;32mdouble[m[00;00m)[m[00;34m0[m[00;00m, ([mb[00;00m.[my [00;00m-[m b[00;00m.[mh [00;00m/[m [00;34m2[m[00;00m.)*[mim[00;00m.[mh[00;00m);[m
            bbox[00;00m.[mw [00;00m=[m b[00;00m.[mw[00;00m*[mim[00;00m.[mw[00;00m;[m
            bbox[00;00m.[mh [00;00m=[m b[00;00m.[mh[00;00m*[mim[00;00m.[mh[00;00m;[m
            bbox[00;00m.[mobj_id [00;00m=[m obj_id[00;00m;[m
            bbox[00;00m.[mprob [00;00m=[m prob[00;00m;[m
            bbox[00;00m.[mtrack_id [00;00m=[m [00;34m0[m[00;00m;[m
            bbox[00;00m.[mframes_counter [00;00m=[m [00;34m0[m[00;00m;[m
            bbox[00;00m.[mx_3d [00;00m=[m NAN[00;00m;[m
            bbox[00;00m.[my_3d [00;00m=[m NAN[00;00m;[m
            bbox[00;00m.[mz_3d [00;00m=[m NAN[00;00m;[m

            bbox_vec[00;00m.[m[00;32mpush_back[m[00;00m([mbbox[00;00m);[m
        [00;00m}[m
    [00;00m}[m

    [00;32mfree_detections[m[00;00m([mdets[00;00m,[m nboxes[00;00m);[m
    [00;33mif[m[00;00m([msized[00;00m.[mdata[00;00m)[m
        [00;32mfree[m[00;00m([msized[00;00m.[mdata[00;00m);[m

[00;35m#ifdef GPU[m
    [00;33mif[m [00;00m([mcur_gpu_id [00;00m!=[m old_gpu_index[00;00m)[m
        [00;32mcudaSetDevice[m[00;00m([mold_gpu_index[00;00m);[m
[00;35m#endif[m

    [00;33mreturn[m bbox_vec[00;00m;[m
[00;00m}[m

LIB_API [00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m [00;32mDetector[m[00;00m::[m[00;32mtracking_id[m[00;00m([m[00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m cur_bbox_vec[00;00m,[m [00;32mbool const[m change_history[00;00m,[m
    [00;32mint const[m frames_story[00;00m,[m [00;32mint const[m max_dist[00;00m)[m
[00;00m{[m
    detector_gpu_t [00;00m&[mdet_gpu [00;00m= *[m[00;33mstatic_cast[m[00;00m<[mdetector_gpu_t [00;00m*>([mdetector_gpu_ptr[00;00m.[m[00;32mget[m[00;00m());[m

    [00;32mbool[m prev_track_id_present [00;00m=[m [00;33mfalse[m[00;00m;[m
    [00;33mfor[m [00;00m([m[00;32mauto[m [00;00m&[mi [00;00m:[m prev_bbox_vec_deque[00;00m)[m
        [00;33mif[m [00;00m([mi[00;00m.[m[00;32msize[m[00;00m() >[m [00;34m0[m[00;00m)[m prev_track_id_present [00;00m=[m [00;33mtrue[m[00;00m;[m

    [00;33mif[m [00;00m(![mprev_track_id_present[00;00m) {[m
        [00;33mfor[m [00;00m([m[00;32msize_t[m i [00;00m=[m [00;34m0[m[00;00m;[m i [00;00m<[m cur_bbox_vec[00;00m.[m[00;32msize[m[00;00m(); ++[mi[00;00m)[m
            cur_bbox_vec[00;00m[[mi[00;00m].[mtrack_id [00;00m=[m det_gpu[00;00m.[mtrack_id[00;00m[[mcur_bbox_vec[00;00m[[mi[00;00m].[mobj_id[00;00m]++;[m
        prev_bbox_vec_deque[00;00m.[m[00;32mpush_front[m[00;00m([mcur_bbox_vec[00;00m);[m
        [00;33mif[m [00;00m([mprev_bbox_vec_deque[00;00m.[m[00;32msize[m[00;00m() >[m frames_story[00;00m)[m prev_bbox_vec_deque[00;00m.[m[00;32mpop_back[m[00;00m();[m
        [00;33mreturn[m cur_bbox_vec[00;00m;[m
    [00;00m}[m

    [00;32mstd[m[00;00m::[mvector[00;00m<[m[00;32munsigned int[m[00;00m>[m [00;32mdist_vec[m[00;00m([mcur_bbox_vec[00;00m.[m[00;32msize[m[00;00m(),[m [00;32mstd[m[00;00m::[mnumeric_limits[00;00m<[m[00;32munsigned int[m[00;00m>::[m[00;32mmax[m[00;00m());[m

    [00;33mfor[m [00;00m([m[00;32mauto[m [00;00m&[mprev_bbox_vec [00;00m:[m prev_bbox_vec_deque[00;00m) {[m
        [00;33mfor[m [00;00m([m[00;32mauto[m [00;00m&[mi [00;00m:[m prev_bbox_vec[00;00m) {[m
            [00;32mint[m cur_index [00;00m= -[m[00;34m1[m[00;00m;[m
            [00;33mfor[m [00;00m([m[00;32msize_t[m m [00;00m=[m [00;34m0[m[00;00m;[m m [00;00m<[m cur_bbox_vec[00;00m.[m[00;32msize[m[00;00m(); ++[mm[00;00m) {[m
                bbox_t [00;32mconst[m[00;00m&[m k [00;00m=[m cur_bbox_vec[00;00m[[mm[00;00m];[m
                [00;33mif[m [00;00m([mi[00;00m.[mobj_id [00;00m==[m k[00;00m.[mobj_id[00;00m) {[m
                    [00;32mfloat[m center_x_diff [00;00m= ([m[00;32mfloat[m[00;00m)([mi[00;00m.[mx [00;00m+[m i[00;00m.[mw[00;00m/[m[00;34m2[m[00;00m) - ([m[00;32mfloat[m[00;00m)([mk[00;00m.[mx [00;00m+[m k[00;00m.[mw[00;00m/[m[00;34m2[m[00;00m);[m
                    [00;32mfloat[m center_y_diff [00;00m= ([m[00;32mfloat[m[00;00m)([mi[00;00m.[my [00;00m+[m i[00;00m.[mh[00;00m/[m[00;34m2[m[00;00m) - ([m[00;32mfloat[m[00;00m)([mk[00;00m.[my [00;00m+[m k[00;00m.[mh[00;00m/[m[00;34m2[m[00;00m);[m
                    [00;32munsigned int[m cur_dist [00;00m=[m [00;32msqrt[m[00;00m([mcenter_x_diff[00;00m*[mcenter_x_diff [00;00m+[m center_y_diff[00;00m*[mcenter_y_diff[00;00m);[m
                    [00;33mif[m [00;00m([mcur_dist [00;00m<[m max_dist [00;00m&& ([mk[00;00m.[mtrack_id [00;00m==[m [00;34m0[m [00;00m||[m dist_vec[00;00m[[mm[00;00m] >[m cur_dist[00;00m)) {[m
                        dist_vec[00;00m[[mm[00;00m] =[m cur_dist[00;00m;[m
                        cur_index [00;00m=[m m[00;00m;[m
                    [00;00m}[m
                [00;00m}[m
            [00;00m}[m

            [00;32mbool[m track_id_absent [00;00m= ![m[00;32mstd[m[00;00m::[m[00;32many_of[m[00;00m([mcur_bbox_vec[00;00m.[m[00;32mbegin[m[00;00m(),[m cur_bbox_vec[00;00m.[m[00;32mend[m[00;00m(),[m
                [00;00m[&[mi[00;00m]([mbbox_t [00;32mconst[m[00;00m&[m b[00;00m) {[m [00;33mreturn[m b[00;00m.[mtrack_id [00;00m==[m i[00;00m.[mtrack_id [00;00m&&[m b[00;00m.[mobj_id [00;00m==[m i[00;00m.[mobj_id[00;00m; });[m

            [00;33mif[m [00;00m([mcur_index [00;00m>=[m [00;34m0[m [00;00m&&[m track_id_absent[00;00m){[m
                cur_bbox_vec[00;00m[[mcur_index[00;00m].[mtrack_id [00;00m=[m i[00;00m.[mtrack_id[00;00m;[m
                cur_bbox_vec[00;00m[[mcur_index[00;00m].[mw [00;00m= ([mcur_bbox_vec[00;00m[[mcur_index[00;00m].[mw [00;00m+[m i[00;00m.[mw[00;00m) /[m [00;34m2[m[00;00m;[m
                cur_bbox_vec[00;00m[[mcur_index[00;00m].[mh [00;00m= ([mcur_bbox_vec[00;00m[[mcur_index[00;00m].[mh [00;00m+[m i[00;00m.[mh[00;00m) /[m [00;34m2[m[00;00m;[m
            [00;00m}[m
        [00;00m}[m
    [00;00m}[m

    [00;33mfor[m [00;00m([m[00;32msize_t[m i [00;00m=[m [00;34m0[m[00;00m;[m i [00;00m<[m cur_bbox_vec[00;00m.[m[00;32msize[m[00;00m(); ++[mi[00;00m)[m
        [00;33mif[m [00;00m([mcur_bbox_vec[00;00m[[mi[00;00m].[mtrack_id [00;00m==[m [00;34m0[m[00;00m)[m
            cur_bbox_vec[00;00m[[mi[00;00m].[mtrack_id [00;00m=[m det_gpu[00;00m.[mtrack_id[00;00m[[mcur_bbox_vec[00;00m[[mi[00;00m].[mobj_id[00;00m]++;[m

    [00;33mif[m [00;00m([mchange_history[00;00m) {[m
        prev_bbox_vec_deque[00;00m.[m[00;32mpush_front[m[00;00m([mcur_bbox_vec[00;00m);[m
        [00;33mif[m [00;00m([mprev_bbox_vec_deque[00;00m.[m[00;32msize[m[00;00m() >[m frames_story[00;00m)[m prev_bbox_vec_deque[00;00m.[m[00;32mpop_back[m[00;00m();[m
    [00;00m}[m

    [00;33mreturn[m cur_bbox_vec[00;00m;[m
[00;00m}[m


LIB_API [00;32mbool[m [00;32mDetector[m[00;00m::[m[00;32msend_json_http[m[00;00m([m[00;32mstd[m[00;00m::[mvector[00;00m<[mbbox_t[00;00m>[m cur_bbox_vec[00;00m,[m [00;32mstd[m[00;00m::[mvector[00;00m<[m[00;32mstd[m[00;00m::[mstring[00;00m>[m obj_names[00;00m,[m [00;32mint[m frame_id[00;00m,[m [00;32mstd[m[00;00m::[mstring filename[00;00m,[m [00;32mint[m timeout[00;00m,[m [00;32mint[m port[00;00m)[m
[00;00m{[m
    [00;34m//int timeout = 400000;[m
    [00;34m//int port = 8070;[m
    [00;34m//send_json(local_dets, local_nboxes, l.classes, demo_names, frame_id, demo_json_port, timeout);[m

    [00;32mstd[m[00;00m::[mstring send_str[00;00m;[m

    [00;32mchar[m [00;00m*[mtmp_buf [00;00m= ([m[00;32mchar[m [00;00m*)[m[00;32mcalloc[m[00;00m([m[00;34m1024[m[00;00m,[m [00;33msizeof[m[00;00m([m[00;32mchar[m[00;00m));[m
    [00;33mif[m [00;00m(![mfilename[00;00m.[m[00;32mempty[m[00;00m()) {[m
        [00;32msprintf[m[00;00m([mtmp_buf[00;00m,[m [00;31m"{[m[00;35m\n \"[m[00;31mframe_id[m[00;35m\"[m[00;31m:%d,[m [00;35m\n \"[m[00;31mfilename[m[00;35m\"[m[00;31m:[m[00;35m\"[m[00;31m%s[m[00;35m\"[m[00;31m,[m [00;35m\n \"[m[00;31mobjects[m[00;35m\"[m[00;31m: [[m [00;35m\n[m[00;31m"[m[00;00m,[m frame_id[00;00m,[m filename[00;00m.[m[00;32mc_str[m[00;00m());[m
    [00;00m}[m
    [00;33melse[m [00;00m{[m
        [00;32msprintf[m[00;00m([mtmp_buf[00;00m,[m [00;31m"{[m[00;35m\n \"[m[00;31mframe_id[m[00;35m\"[m[00;31m:%d,[m [00;35m\n \"[m[00;31mobjects[m[00;35m\"[m[00;31m: [[m [00;35m\n[m[00;31m"[m[00;00m,[m frame_id[00;00m);[m
    [00;00m}[m
    send_str [00;00m=[m tmp_buf[00;00m;[m
    [00;32mfree[m[00;00m([mtmp_buf[00;00m);[m

    [00;33mfor[m [00;00m([m[00;32mauto[m [00;00m&[m i [00;00m:[m cur_bbox_vec[00;00m) {[m
        [00;32mchar[m [00;00m*[mbuf [00;00m= ([m[00;32mchar[m [00;00m*)[m[00;32mcalloc[m[00;00m([m[00;34m2048[m[00;00m,[m [00;33msizeof[m[00;00m([m[00;32mchar[m[00;00m));[m

        [00;32msprintf[m[00;00m([mbuf[00;00m,[m [00;31m"  {[m[00;35m\"[m[00;31mclass_id[m[00;35m\"[m[00;31m:%d,[m [00;35m\"[m[00;31mname[m[00;35m\"[m[00;31m:[m[00;35m\"[m[00;31m%s[m[00;35m\"[m[00;31m,[m [00;35m\"[m[00;31mabsolute_coordinates[m[00;35m\"[m[00;31m:{[m[00;35m\"[m[00;31mcenter_x[m[00;35m\"[m[00;31m:%d,[m [00;35m\"[m[00;31mcenter_y[m[00;35m\"[m[00;31m:%d,[m [00;35m\"[m[00;31mwidth[m[00;35m\"[m[00;31m:%d,[m [00;35m\"[m[00;31mheight[m[00;35m\"[m[00;31m:%d},[m [00;35m\"[m[00;31mconfidence[m[00;35m\"[m[00;31m:%f"[m[00;00m,[m
            i[00;00m.[mobj_id[00;00m,[m obj_names[00;00m[[mi[00;00m.[mobj_id[00;00m].[m[00;32mc_str[m[00;00m(),[m i[00;00m.[mx[00;00m,[m i[00;00m.[my[00;00m,[m i[00;00m.[mw[00;00m,[m i[00;00m.[mh[00;00m,[m i[00;00m.[mprob[00;00m);[m

        [00;34m//sprintf(buf, "  {\"class_id\":%d, \"name\":\"%s\", \"relative_coordinates\":{\"center_x\":%f, \"center_y\":%f, \"width\":%f, \"height\":%f}, \"confidence\":%f",[m
        [00;34m//    i.obj_id, obj_names[i.obj_id], i.x, i.y, i.w, i.h, i.prob);[m

        send_str [00;00m+=[m buf[00;00m;[m

        [00;33mif[m [00;00m(![m[00;32mstd[m[00;00m::[m[00;32misnan[m[00;00m([mi[00;00m.[mz_3d[00;00m)) {[m
            [00;32msprintf[m[00;00m([mbuf[00;00m,[m [00;31m"[m[00;35m\n[m    [00;31m,[m [00;35m\"[m[00;31mcoordinates_in_meters[m[00;35m\"[m[00;31m:{[m[00;35m\"[m[00;31mx_3d[m[00;35m\"[m[00;31m:%.2f,[m [00;35m\"[m[00;31my_3d[m[00;35m\"[m[00;31m:%.2f,[m [00;35m\"[m[00;31mz_3d[m[00;35m\"[m[00;31m:%.2f}"[m[00;00m,[m
                i[00;00m.[mx_3d[00;00m,[m i[00;00m.[my_3d[00;00m,[m i[00;00m.[mz_3d[00;00m);[m
            send_str [00;00m+=[m buf[00;00m;[m
        [00;00m}[m

        send_str [00;00m+=[m [00;31m"}[m[00;35m\n[m[00;31m"[m[00;00m;[m

        [00;32mfree[m[00;00m([mbuf[00;00m);[m
    [00;00m}[m

    [00;34m//send_str +=  "\n ] \n}, \n";[m
    send_str [00;00m+=[m [00;31m"[m[00;35m\n[m [00;31m][m [00;35m\n[m[00;31m}"[m[00;00m;[m

    [00;32msend_json_custom[m[00;00m([msend_str[00;00m.[m[00;32mc_str[m[00;00m(),[m port[00;00m,[m timeout[00;00m);[m
    [00;33mreturn true[m[00;00m;[m
[00;00m}[m

[00;32mvoid[m [00;00m*[m[00;32mDetector[m[00;00m::[m[00;32mget_cuda_context[m[00;00m()[m
[00;00m{[m
[00;35m#ifdef GPU[m
    [00;32mint[m old_gpu_index[00;00m;[m
    [00;32mcudaGetDevice[m[00;00m(&[mold_gpu_index[00;00m);[m
    [00;33mif[m [00;00m([mcur_gpu_id [00;00m!=[m old_gpu_index[00;00m)[m
        [00;32mcudaSetDevice[m[00;00m([mcur_gpu_id[00;00m);[m

    [00;32mvoid[m [00;00m*[mcuda_context [00;00m=[m [00;32mcuda_get_context[m[00;00m();[m

    [00;33mif[m [00;00m([mcur_gpu_id [00;00m!=[m old_gpu_index[00;00m)[m
        [00;32mcudaSetDevice[m[00;00m([mold_gpu_index[00;00m);[m

    [00;33mreturn[m cuda_context[00;00m;[m
[00;35m#else[m   [00;34m// GPU[m
[00;35m[m    [00;33mreturn[m NULL[00;00m;[m
[00;35m#endif[m  [00;34m// GPU[m
[00;35m[m[00;00m}[m
